<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Velvet ‚Äî Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark">
  <style>
    html.velvet, html.velvet body { background:#0a0a0a !important; color:#f1f1f1 !important; }
    html.velvet *{ box-sizing:border-box }
    :root{--bg:#0a0a0a;--panel:#111;--text:#f1f1f1;--muted:#b9b9b9;--gold:#c8a64d;--gold2:#ffd369;--line:#1f1f1f;--bad:#ff6b6b}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:#0b0b0b;border-right:1px solid var(--line);padding:18px;display:flex;flex-direction:column;gap:16px}
    .sidebar h2{margin:4px 0 8px;color:var(--gold2);font-size:18px;letter-spacing:.5px}
    .nav a{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:8px;color:#ddd;text-decoration:none}
    .nav a:hover{background:#151515}
    .nav a.active{background:#16140e;border:1px solid var(--gold);color:#fff}
    .foot{margin-top:auto;color:#777;font-size:12.5px}
    .main{padding:18px 20px}
    .topbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center}
    .input{background:#1a1a1a !important;border:1px solid #333 !important;border-radius:6px;padding:10px 12px;color:#fff !important;min-width:260px}
    .btn{background:linear-gradient(90deg,var(--gold),var(--gold2));border:0;border-radius:6px;padding:10px 14px;color:#000;font-weight:700;cursor:pointer}
    .btn.ghost{background:#222;color:#fff;border:1px solid var(--gold)}
    .chip{background:#16140e;border:1px solid var(--gold);color:#fff;border-radius:999px;padding:8px 11px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:14px}
    .card h3{margin:0 0 8px;color:var(--gold2);font-size:15px}
    .card .value{font-size:24px;font-weight:800}
    .card .bad{color:var(--bad)}
    .section{margin-top:18px;background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:14px}
    h2{margin:0 0 12px;color:var(--gold2)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #222;text-align:left}
    thead th{color:#e8e8e8}
    tbody tr:hover{background:#151515}
    .small{color:#888;font-size:12.5px;margin-top:14px}
    @media (max-width:960px){.layout{grid-template-columns:1fr}.sidebar{position:sticky;top:0;z-index:2}}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>VELVET ADMIN</h2>
      <nav class="nav">
        <a href="#overview" class="active">üè† Aper√ßu</a>
        <a href="#sales">üí≥ Ventes</a>
        <a href="#conversations">üí¨ Conversations</a>
        <a href="#lives">üé• Lives</a>
        <a href="/admin-users.html">üë• Comptes</a>
        <a href="/admin-items.html">üõçÔ∏è Cr√©er un item</a>
      </nav>
      <div class="foot">¬© Velvet Creators VIP</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="q" class="input" type="text" placeholder="Rechercher (pseudo, email)">
          <button class="btn" id="btnFilter">Filtrer</button>
        </div>
        <div class="chips">
          <span class="chip" id="clock">--:--:--</span>
          <button class="btn ghost" id="btnPurge">Purger inactifs (90 j)</button>
          <button class="btn" id="btnReload">Rafra√Æchir</button>
        </div>
      </div>

      <!-- Aper√ßu -->
      <section class="section" data-tab id="overview">
        <div class="grid">
          <div class="card"><h3>Utilisateurs en ligne</h3><div class="value" id="k-online">0</div><small>5 derni√®res minutes</small></div>
          <div class="card"><h3>Inscriptions en attente</h3><div class="value" id="k-pending">0</div><small>√† valider</small></div>
          <div class="card"><h3>Ventes (aujourd‚Äôhui)</h3><div class="value" id="k-today">0.00 CHF</div><small>tickets & PPV</small></div>
          <div class="card"><h3>Impay√© total</h3><div class="value bad" id="k-due">0.00 CHF</div><small>√† verser aux cr√©atrices</small></div>
        </div>

        <div class="section" style="margin-top:14px">
          <h2>Derni√®res ventes</h2>
          <table id="t-last">
            <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Client</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>

        <div class="section" style="margin-top:14px">
          <h2>R√©cap ventes par cr√©atrice</h2>
          <table id="t-creators">
            <thead><tr><th>Cr√©atrice</th><th>Total (CHF)</th><th>Pour elle (70%)</th><th>Pour Velvet (30%)</th><th>Impay√©</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
          </table>
          <button class="btn" id="btnCsv" style="margin-top:10px">Exporter CSV</button>
        </div>
      </section>

      <!-- Ventes -->
      <section class="section" data-tab hidden id="sales">
        <h2>D√©tail des ventes</h2>
        <table id="t-ledger">
          <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody><tr><td colspan="8">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </section>

      <!-- Conversations -->
      <section class="section" data-tab hidden id="conversations">
        <h2>Conversations r√©centes</h2>
        <table id="t-conv">
          <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Client</th><th>Type</th><th>Montant</th><th>Message</th></tr></thead>
          <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </section>

      <!-- Lives -->
      <section class="section" data-tab hidden id="lives">
        <h2>Lives</h2>
        <table id="t-live">
          <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Prix du ticket</th><th>Participants</th><th>Statut</th></tr></thead>
          <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </section>

      <footer class="small">Besoin d‚Äôun filtre/onglet en plus ? Dis‚Äëmoi et je l‚Äôajoute.</footer>
    </main>
  </div>

  <script>
    // Activer le th√®me "velvet"
    document.documentElement.classList.add('velvet');

    // Helpers
    const $  = (s, c=document) => c.querySelector(s);
    const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
    const api = (p,opt={}) => fetch(p,{headers:{'Content-Type':'application/json'}, ...opt});
    const fmt = n => Number(n||0).toFixed(2);

    // Onglets via hash
    function activateFromHash() {
      const hash = location.hash || '#overview';
      $$('.nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href')===hash));
      $$('[data-tab]').forEach(sec => { sec.hidden = ('#'+sec.id !== hash); });
    }
    window.addEventListener('hashchange', activateFromHash);
    document.addEventListener('DOMContentLoaded', activateFromHash);

    // Rendus
    function renderLastSales(rows=[]) {
      const tb = $('#t-last tbody'); if(!tb) return;
      tb.innerHTML = '';
      if (!rows.length) { tb.innerHTML = '<tr><td colspan="6">Aucune vente.</td></tr>'; return; }
      rows.slice(0,8).forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'‚Äî'}</td>
          <td>${v.type||'‚Äî'}</td>
          <td>${fmt(v.amount)} CHF</td>
          <td>${v.clientEmail||'‚Äî'}</td>
          <td>${v.paid ? 'Pay√©' : `<button class="btn" data-pay="${v.id||''}">Marquer pay√©</button>`}</td>
        `;
        tb.appendChild(tr);
      });
    }
    function renderCreatorsRecap(map={}) {
      const tb = $('#t-creators tbody'); if(!tb) return;
      tb.innerHTML = '';
      const entries = Object.entries(map);
      if (!entries.length) { tb.innerHTML = '<tr><td colspan="6">Aucune donn√©e.</td></tr>'; return; }
      entries.forEach(([name,val])=>{
        const total = Number(val.total||0), c70 = total*0.7, v30 = total*0.3, due = Number(val.due||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${fmt(total)}</td>
          <td>${fmt(c70)}</td>
          <td>${fmt(v30)}</td>
          <td>${fmt(due)}</td>
          <td>${due>0 ? `<button class="btn" data-bulk="${name}">Marquer tout pay√©</button>` : '‚Äî'}</td>
        `;
        tb.appendChild(tr);
      });
    }
    function renderLedger(rows=[]) {
      const tb = $('#t-ledger tbody'); if(!tb) return;
      tb.innerHTML = '';
      if (!rows.length) { tb.innerHTML = '<tr><td colspan="8">Aucune ligne.</td></tr>'; return; }
      rows.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'‚Äî'}</td>
          <td>${v.type||'‚Äî'}</td>
          <td>${fmt(v.amount)}</td>
          <td>${v.txn||'‚Äî'}</td>
          <td>${v.clientEmail||'‚Äî'}</td>
          <td>${v.paid ? 'Pay√©' : 'Impay√©'}</td>
          <td>${v.paid ? '‚Äî' : `<button class="btn" data-pay="${v.id||''}">Pay√©</button>`}</td>
        `;
        tb.appendChild(tr);
      });
    }
    function renderConvs(rows=[]) {
      const tb = $('#t-conv tbody'); if(!tb) return;
      tb.innerHTML = '';
      if (!rows.length) { tb.innerHTML = '<tr><td colspan="6">Aucune conversation r√©cente.</td></tr>'; return; }
      rows.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'‚Äî'}</td>
          <td>${v.client||'‚Äî'}</td>
          <td>${v.kind||'‚Äî'}</td>
          <td>${fmt(v.amount||0)} ${v.amount?'CHF':''}</td>
          <td>${(v.message||'').slice(0,120)}</td>
        `;
        tb.appendChild(tr);
      });
    }
    function renderLives(rows=[]) {
      const tb = $('#t-live tbody'); if(!tb) return;
      tb.innerHTML = '';
      if (!rows.length) { tb.innerHTML = '<tr><td colspan="6">Aucun live en cours.</td></tr>'; return; }
      rows.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'‚Äî'}</td>
          <td>${v.mode||'‚Äî'}</td>
          <td>${fmt(v.price||0)} CHF</td>
          <td>${v.participants||0}</td>
          <td>${v.status||'‚Äî'}</td>
        `;
        tb.appendChild(tr);
      });
    }

    // Chargement global
    async function loadDashboard() {
      try{
        const r = await api('/api/list-ledger');
        const j = await r.json().catch(()=> ({}));
        $('#k-online') && ($('#k-online').textContent = j.online ?? 0);
        $('#k-pending') && ($('#k-pending').textContent = j.pending ?? 0);
        $('#k-today') && ($('#k-today').textContent = ((j.totals?.today)||0).toFixed(2)+' CHF');
        $('#k-due') && ($('#k-due').textContent = ((j.totals?.due)||0).toFixed(2)+' CHF');
        renderLastSales(j.last||[]);
        renderCreatorsRecap(j.creators||{});
        renderLedger(j.ledger||[]);
      }catch(e){ console.warn('list-ledger ko', e); }
      try{ const rc = await api('/api/list-conversations'); renderConvs((await rc.json()).rows||[]);}catch(e){}
      try{ const rl = await api('/api/list-lives');         renderLives((await rl.json()).rows||[]);}catch(e){}
    }

    async function markPaid(id) {
      try{
        const r = await api('/api/mark-paid',{method:'POST',body:JSON.stringify({id})});
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error||'ko');
        await loadDashboard();
      }catch(e){ alert('Erreur marquage pay√©'); }
    }
    function markAllForCreator(name){ if(confirm('Marquer tout impay√© comme vers√© ?')) markPaid('creator:'+name); }
    async function purgeInactive90d(){ if(!confirm('Supprimer les comptes inactifs depuis 90 jours ?')) return;
      try{ const r=await api('/api/purge-inactive',{method:'POST'}); const j=await r.json(); alert(j.ok?('Supprim√©s: '+(j.count||0)):(j.error||'Erreur')); loadDashboard(); }catch(e){ alert('Erreur purge'); } }

    document.addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-pay]'); if(b) return markPaid(b.dataset.pay);
      const c=e.target.closest('button[data-bulk]'); if(c) return markAllForCreator(c.dataset.bulk);
    });
    $('#btnReload') && ($('#btnReload').onclick = loadDashboard);
    $('#btnCsv')   && ($('#btnCsv').onclick   = ()=>window.location='/api/list-ledger?format=csv');
    $('#btnFilter')&& ($('#btnFilter').onclick= ()=>{ const q=$('#q')?.value||''; location.href='/admin-users.html'+(q?('?q='+encodeURIComponent(q)):''); });
    $('#btnPurge') && ($('#btnPurge').onclick = purgeInactive90d);

    setInterval(()=>{ const c=$('#clock'); if(c) c.textContent=new Date().toLocaleTimeString(); },1000);
    setInterval(loadDashboard, 30_000);

    document.documentElement.classList.add('velvet');
    activateFromHash(); loadDashboard();

    function activateFromHash(){ const hash=location.hash||'#overview';
      document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash));
      document.querySelectorAll('[data-tab]').forEach(sec=>{sec.hidden = ('#'+sec.id !== hash);});
    }
    window.addEventListener('hashchange', activateFromHash);
  </script>
</body>
</html>
