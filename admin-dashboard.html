<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velvet ‚Äî Dashboard admin</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --muted:#9aa4b2; --text:#e8edf2;
      --accent:#7c5cff; --accent-2:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --line:#2a3140; --chip:#1b2130;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1180px; margin:32px auto 80px; padding:0 20px;}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; margin-bottom:18px;
    }
    .brand{font-weight:700; font-size:22px; letter-spacing:.3px}
    .sub{color:var(--muted); font-weight:500; font-size:13px}
    .actions a, .actions button{
      background:var(--chip); color:var(--text); border:1px solid var(--line);
      padding:9px 12px; border-radius:10px; font-weight:600; font-size:13px; cursor:pointer;
    }
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px;}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg,#141a23 0%, #121722 100%);
      border:1px solid var(--line); border-radius:16px; padding:16px 16px 10px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .card h3{margin:0 0 8px; font-size:16px}
    .card .help{margin:-2px 0 12px; color:var(--muted); font-size:12px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 14px}
    .select, .input{background:#0f141e; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:8px 10px; font-size:13px;}
    .btn{background:var(--accent); border:none; color:white; border-radius:10px; padding:9px 12px; font-weight:700; cursor:pointer}
    .btn.outline{background:transparent; border:1px solid var(--line); color:var(--text)}
    .btn.success{background:var(--accent-2)}
    .btn.warn{background:var(--warn); color:#0b0b0b}
    .btn.danger{background:var(--danger)}
    .btn.small{padding:6px 10px; font-size:12px; border-radius:8px}
    .statgrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:8px 0 6px}
    @media (max-width:720px){ .statgrid{grid-template-columns:1fr 1fr} }
    .stat{background:#101626; border:1px solid var(--line); border-radius:12px; padding:12px}
    .stat .k{font-weight:700; font-size:18px}
    .stat .l{color:var(--muted); font-size:12px}
    table{width:100%; border-collapse:collapse; border-spacing:0; font-size:13px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:middle}
    th{text-align:left; color:#d3d8df; font-weight:600; background:#121827; position:sticky; top:0; z-index:1}
    tbody tr:hover{background:#131a28}
    .chip{background:var(--chip); color:var(--text); border:1px solid var(--line); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .chip.ok{background:rgba(16,185,129,.12); color:#86f3cf; border-color:rgba(16,185,129,.35)}
    .chip.suspended{background:rgba(245,158,11,.12); color:#ffd37b; border-color:rgba(245,158,11,.35)}
    .chip.pending{background:rgba(124,92,255,.12); color:#c3b5ff; border-color:rgba(124,92,255,.35)}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .tablewrap{max-height:380px; overflow:auto; border:1px solid var(--line); border-radius:12px}
    .hr{height:1px; background:var(--line); margin:16px 0}
    .toast{
      position:fixed; right:16px; bottom:16px; display:none; padding:12px 14px; border-radius:12px; background:#101726;
      border:1px solid var(--line); color:var(--text); font-weight:600; box-shadow:0 10px 24px rgba(0,0,0,.3)
    }
    .empty{padding:22px; text-align:center; color:var(--muted)}
    .link{color:#8ab4ff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">Velvet ‚Äî Dashboard (admin)</div>
        <div class="sub">Mod√®re les comptes & suis les ventes en temps r√©el.</div>
      </div>
      <div class="actions">
        <a href="/admin-items.html">‚ûï Cr√©er un item</a>
        <a href="/index.html">üè† Accueil</a>
      </div>
    </header>

    <div class="grid">
      <!-- COMPTES -->
      <section class="card">
        <h3>Comptes ‚Äî valider / suspendre / supprimer</h3>
        <div class="help">‚ÄúSuspendre‚Äù coupe l‚Äôacc√®s sans effacer les donn√©es. Tu peux r√©activer ensuite.</div>

        <div class="toolbar">
          <select id="fStatus" class="select">
            <option value="">Statut : Tous</option>
            <option value="pending">En attente</option>
            <option value="active">Actifs</option>
            <option value="suspended">Suspendus</option>
          </select>
          <select id="fRole" class="select">
            <option value="">R√¥le : Tous</option>
            <option value="creator">Cr√©atrices</option>
            <option value="client">Clients</option>
            <option value="admin">Admins</option>
          </select>
          <input id="fQuery" class="input" placeholder="Recherche (pseudo / email)">
          <button id="refreshUsers" class="btn outline">Rafra√Æchir</button>
        </div>

        <div class="tablewrap" id="usersWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- STAT & VENTES -->
      <section class="card">
        <h3>Ventes & r√©partition (70% / 30%)</h3>
        <div class="help">Clique sur <b>‚ÄúMarquer pay√©‚Äù</b> apr√®s ton virement PayPal √† la cr√©atrice.</div>

        <div class="statgrid" id="kpis">
          <div class="stat"><div class="k" id="kTot">‚Äî CHF</div><div class="l">Ventes totales</div></div>
          <div class="stat"><div class="k" id="kCrea">‚Äî CHF</div><div class="l">Pour cr√©atrices (70%)</div></div>
          <div class="stat"><div class="k" id="kVelvet">‚Äî CHF</div><div class="l">Pour Velvet (30%)</div></div>
        </div>

        <div class="hr"></div>
        <div class="toolbar" style="justify-content:space-between">
          <div class="help">R√©cap par cr√©atrice</div>
          <button id="exportCsv" class="btn small outline">Exporter CSV</button>
        </div>

        <div class="tablewrap" id="creaWrap" style="margin-top:6px">
          <table>
            <thead>
              <tr>
                <th>Cr√©atrice</th><th class="right">Ventes (CHF)</th><th class="right">Pour elle (70%)</th><th class="right">Pour Velvet (30%)</th><th class="right">Impay√©</th><th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="creaTbody">
              <tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- D√âTAIL DES VENTES -->
    <section class="card" style="margin-top:18px">
      <h3>D√©tail des ventes</h3>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="right">Montant</th><th>Txn</th><th>Email client</th><th>Statut</th>
            </tr>
          </thead>
          <tbody id="salesTbody">
            <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ------- helpers UI
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const toast = (txt, ms=2200)=>{ const t=$("#toast"); t.textContent=txt; t.style.display="block"; setTimeout(()=>t.style.display="none", ms); };
    const money = n => (Number(n||0)).toFixed(2).replace('.', ',');

    // ------- endpoints
    const api = {
      listUsers: () => fetch('/api/list-users').then(r=>r.json()),
      suspend: (email, reason) => fetch('/api/suspend-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,reason})}).then(r=>r.json()),
      unsuspend: (email) => fetch('/api/unsuspend-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})}).then(r=>r.json()),
      delUser: (email) => fetch('/api/delete-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})}).then(r=>r.json()),
      listLedger: () => fetch('/api/list-ledger').then(r=>r.json()),
      markPaid: (creatorId) => fetch('/api/mark-paid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({creatorId})}).then(r=>r.json()),
    };

    // ------- state
    let USERS = [];
    let LEDGER = { totals:{}, creators:{}, sales:[] };

    // ------- USERS TABLE
    async function loadUsers(){
      $("#usersTbody").innerHTML = `<tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>`;
      const data = await api.listUsers();
      USERS = data.users || [];
      renderUsers();
    }

    function renderUsers(){
      const status = $("#fStatus").value;
      const role = $("#fRole").value;
      const q = ($("#fQuery").value || "").trim().toLowerCase();

      const rows = USERS
        .filter(u => !status || u.status===status)
        .filter(u => !role || u.role===role)
        .filter(u => !q || (u.username?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q)))
        .map(u => {
          const badge = u.status==='active' ? 'ok' : (u.status==='suspended' ? 'suspended' : 'pending');
          const d = new Date(u.createdAt || u.created || Date.now()).toLocaleString();
          let actions = '';
          if (u.status==='suspended'){
            actions += `<button class="btn small success" data-act="unsuspend" data-email="${u.email}">R√©activer</button> `;
          } else if (u.status==='active' || u.status==='pending'){
            actions += `<button class="btn small warn" data-act="suspend" data-email="${u.email}">Suspendre</button> `;
          }
          actions += `<button class="btn small danger" data-act="delete" data-email="${u.email}">Supprimer</button>`;
          return `
            <tr>
              <td class="muted">${d}</td>
              <td>${u.username || '‚Äî'}</td>
              <td class="muted">${u.email}</td>
              <td><span class="chip">${u.role || 'client'}</span></td>
              <td><span class="chip ${badge}">${u.status || 'pending'}</span></td>
              <td class="right">${actions}</td>
            </tr>`;
        });

      $("#usersTbody").innerHTML = rows.length ? rows.join('') : `<tr><td colspan="6" class="empty">Aucun r√©sultat.</td></tr>`;
    }

    // actions users
    $("#usersTbody").addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const email = btn.dataset.email; const act = btn.dataset.act;
      if(!email) return;

      if(act==='suspend'){
        const reason = prompt("Motif de suspension (optionnel) :","");
        const r = await api.suspend(email, reason||'');
        if(r.ok) { toast('Compte suspendu'); loadUsers(); } else toast('Erreur suspension');
      }
      if(act==='unsuspend'){
        const r = await api.unsuspend(email);
        if(r.ok) { toast('Compte r√©activ√©'); loadUsers(); } else toast('Erreur r√©activation');
      }
      if(act==='delete'){
        if(!confirm("Supprimer d√©finitivement ce profil ?")) return;
        const r = await api.delUser(email);
        if(r.ok) { toast('Profil supprim√©'); loadUsers(); } else toast('Erreur suppression');
      }
    });

    // ------- LEDGER / SALES
    async function loadLedger(){
      $("#creaTbody").innerHTML = `<tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>`;
      $("#salesTbody").innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;
      const data = await api.listLedger();
      LEDGER = data || { totals:{}, creators:{}, sales:[] };
      renderLedger();
    }

    function renderLedger(){
      const t = LEDGER.totals || {};
      $("#kTot").textContent = `${money(t.total||0)} CHF`;
      $("#kCrea").textContent = `${money(t.toCreators||0)} CHF`;
      $("#kVelvet").textContent = `${money(t.toVelvet||0)} CHF`;

      // recap cr√©atrices
      const rows = Object.values(LEDGER.creators||{}).map(c=>{
        const due = (c.toCreator||0) - (c.alreadyPaid||0);
        return `
          <tr>
            <td>${c.name||c.id||'‚Äî'}</td>
            <td class="right">${money(c.total||0)}</td>
            <td class="right">${money(c.toCreator||0)}</td>
            <td class="right">${money(c.toVelvet||0)}</td>
            <td class="right">${money(due)}</td>
            <td class="right">
              <button class="btn small ${due>0?'success':'outline'}" data-act="mark" data-id="${c.id}" ${due<=0?'disabled':''}>
                ${due>0?'Marquer pay√©':'OK'}
              </button>
            </td>
          </tr>`;
      });
      $("#creaTbody").innerHTML = rows.length ? rows.join('') : `<tr><td colspan="6" class="empty">Pas encore de ventes.</td></tr>`;

      // d√©tail ventes
      const rowsS = (LEDGER.sales||[]).map(s=>{
        const d = new Date(s.date||Date.now()).toLocaleString();
        return `
          <tr>
            <td class="muted">${d}</td>
            <td>${s.creatorName||s.creatorId||'‚Äî'}</td>
            <td><span class="chip">${s.type||'ppv'}</span></td>
            <td class="right">${money(s.amount||0)}</td>
            <td class="muted">${s.txn || '‚Äî'}</td>
            <td class="muted">${s.buyerEmail || '‚Äî'}</td>
            <td><span class="chip ${s.status==='paid'?'ok':'pending'}">${s.status||'pending'}</span></td>
          </tr>`;
      });
      $("#salesTbody").innerHTML = rowsS.length ? rowsS.join('') : `<tr><td colspan="7" class="empty">Aucune vente.</td></tr>`;
    }

    // mark paid
    $("#creaTbody").addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(btn.dataset.act!=='mark') return;
      const id = btn.dataset.id; if(!id) return;
      if(!confirm("Confirmer : marquer comme pay√© ?")) return;
      const r = await api.markPaid(id);
      if(r.ok){ toast('Marqu√© pay√©'); loadLedger(); } else { toast('Erreur ‚Äúmarqu√© pay√©‚Äù'); }
    });

    // CSV export cr√©atrices
    $("#exportCsv").addEventListener('click', ()=>{
      const rows = [['creatrice','ventes','pour_elle_70','pour_velvet_30','impaye']];
      Object.values(LEDGER.creators||{}).forEach(c=>{
        const due = (c.toCreator||0) - (c.alreadyPaid||0);
        rows.push([c.name||c.id, (c.total||0), (c.toCreator||0), (c.toVelvet||0), due]);
      });
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `velvet_recap_creatrices_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    // filters
    $("#fStatus").onchange = renderUsers;
    $("#fRole").onchange = renderUsers;
    $("#fQuery").oninput = renderUsers;
    $("#refreshUsers").onclick = loadUsers;

    // boot
    loadUsers();
    loadLedger();
  </script>
</body>
</html>
