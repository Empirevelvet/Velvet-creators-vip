<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Velvet — Créer un item</title>
<style>
  .ui{--bg:#0f1115;--panel:#171923;--ink:#e8ecf3;--muted:#9aa4b2;--line:#262a36;
      --brand:#8b5cf6;--brand-ink:#7245ea;--ok:#2bd4a7;--danger:#ef4444;--chip:#1b2030;--radius:14px;
      background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,Inter,Roboto,Arial}
  *{box-sizing:border-box}
  .wrap{max-width:940px;margin:0 auto;padding:22px 16px}
  header{position:sticky;top:0;z-index:10;background:#0f1115cc;backdrop-filter:saturate(120%) blur(8px);
         border-bottom:1px solid var(--line)}
  h1{font-size:28px;margin:8px 0 6px}
  .muted{color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:18px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
  label{display:block;margin:12px 0 6px;font-weight:700}
  .input,select,textarea{width:100%;background:#121522;color:var(--ink);border:1px solid var(--line);
    border-radius:12px;padding:12px 12px;outline:none}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{appearance:none;background:var(--brand);color:#fff;border:0;border-radius:11px;
       padding:10px 14px;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--brand-ink)}
  .btn.ghost{background:#0f1115;border:1px solid var(--line);color:var(--ink)}
  .help{font-size:13px;color:var(--muted)}
  .chip{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#131722;color:#c9d1e3;font-size:12px}
  .preview{margin-top:10px;border:1px dashed #30364a;border-radius:12px;padding:10px;min-height:80px;display:flex;align-items:center;justify-content:center;color:#94a3b8}
  .ok{color:var(--ok)} .err{color:var(--danger)}
</style>
</head>
<body class="ui">
<header><div class="wrap" style="display:flex;gap:10px;align-items:center">
  <strong>Velvet — Admin</strong><span style="opacity:.5">/ Créer un item</span>
  <span style="flex:1"></span>
  <a class="btn ghost" href="/admin-dashboard.html">Dashboard</a>
</div></header>

<main class="wrap">
  <h1>Créer un item (photo / vidéo / PPV / live)</h1>
  <p class="muted">Renseigne le prix et (optionnel) associe l’item à une créatrice pour le suivi des revenus.</p>

  <div class="grid">
    <section class="panel">
      <label for="creatorId">ID créatrice (optionnel)</label>
      <input class="input" id="creatorId" placeholder="ex: user_1234 (ou laisse vide pour ‘creatrice-demo’)"/>

      <div class="row">
        <div>
          <label for="title">Titre</label>
          <input class="input" id="title" placeholder="ex: Live privé du samedi soir"/>
        </div>
        <div>
          <label for="type">Type</label>
          <select id="type" class="input">
            <option value="ppv_image">Image (PPV)</option>
            <option value="ppv_video">Vidéo (PPV)</option>
            <option value="ppv_file">Fichier (PPV)</option>
            <option value="live">Accès Live — ticket</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="price">Prix (CHF)</label>
          <input class="input" id="price" type="number" inputmode="decimal" min="0" step="0.1" placeholder="0.00"/>
        </div>
        <div id="liveFields" style="display:none">
          <label for="room">Nom de salle (pour LIVE)</label>
          <input class="input" id="room" placeholder="ex: saturday-live-21h"/>
        </div>
      </div>

      <label for="notes">Notes privées (optionnel)</label>
      <textarea id="notes" rows="3" class="input" placeholder="Infos internes (non visibles client)"></textarea>

      <div class="preview" id="pv">Aucun aperçu</div>

      <div style="display:flex;gap:10px;margin-top:14px">
        <button id="create" class="btn">Créer l’item</button>
        <button id="reset" class="btn ghost">Réinitialiser</button>
        <span id="msg" class="help"></span>
      </div>
    </section>

    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;font-size:16px">Récapitulatif</h3>
        <span class="chip" id="rev">70% / 30%</span>
      </div>
      <div class="help" style="margin-top:8px">
        • <b>70%</b> pour la créatrice, <b>30%</b> pour Velvet.<br/>
        • Pour un <b>LIVE</b>, renseigne le <b>nom de salle</b> (room).<br/>
        • Après création, partage l’URL de paiement au client.
      </div>
      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">
      <div class="help">Exemple d’URL de paiement générée :</div>
      <code id="urlEx" class="chip" style="display:block;margin-top:8px;overflow:auto">—</code>
    </aside>
  </div>
</main>

<script>
  const $=s=>document.querySelector(s);
  const fmt=v=>Number(v||0).toFixed(2);
  const u=(id)=>encodeURIComponent(id);

  function refreshRevenue(){
    const p=parseFloat($("#price").value||0);
    const c=fmt(p*0.70), v=fmt(p*0.30);
    $("#rev").textContent=`Créatrice ${c} / Velvet ${v}`;
  }
  $("#price").oninput=refreshRevenue; refreshRevenue();
  $("#type").onchange=()=>{ const isLive=$("#type").value==='live'; $("#liveFields").style.display=isLive?'block':'none'; };

  $("#reset").onclick=()=>{
    ["creatorId","title","price","room","notes"].forEach(id=>$("#"+id).value="");
    $("#type").value="ppv_image"; $("#liveFields").style.display="none";
    $("#pv").textContent="Aucun aperçu"; $("#msg").textContent=""; $("#urlEx").textContent="—";
  };

  $("#create").onclick=async()=>{
    const price=parseFloat($("#price").value||"0");
    if(!price || price<=0){ $("#msg").textContent="Le prix doit être supérieur à 0"; $("#msg").className="err"; return; }
    const body={
      creatorId: ($("#creatorId").value||'creatrice-demo').trim(),
      title: ($("#title").value||'Sans titre').trim(),
      type: $("#type").value,
      price,
      roomName: ($("#room").value||'').trim(),
      notes: ($("#notes").value||'').trim()
    };
    $("#msg").textContent="Création…"; $("#msg").className="help";
    try{
      const r=await fetch('/api/upsert-item',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json();
      if(!r.ok || !j.success){ $("#msg").textContent=j.error||'Erreur serveur'; $("#msg").className="err"; return; }
      const payUrl=`/paiement.html?itemId=${u(j.itemId)}`;
      $("#pv").innerHTML=`Item <b class="ok">${j.itemId}</b> créé.`;
      $("#urlEx").textContent=location.origin+payUrl;
      $("#msg").textContent="OK – lien de paiement prêt.";
      $("#msg").className="ok";
    }catch(e){ $("#msg").textContent="Erreur réseau"; $("#msg").className="err"; }
  };
</script>
</body>
</html>
