<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Velvet — Créer un item</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/admin.css" />
</head>
<body>
  <aside class="sidebar">
    <h2>VELVET ADMIN</h2>
    <nav class="nav">
      <a href="/admin-dashboard.html">Aperçu</a>
      <a href="/admin-users.html">Comptes</a>
      <a href="/admin-dashboard.html#sales">Ventes</a>
      <a href="/admin-dashboard.html#convs">Conversations</a>
      <a href="/admin-dashboard.html#lives">Lives</a>
      <a class="active" href="/admin-items.html">Créer un item</a>
    </nav>
    <div class="foot">© Velvet Creators VIP</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="chips"><a class="btn ghost" href="/admin-dashboard.html">Dashboard</a></div>
      <div class="chips"><button class="btn" id="reset">Réinitialiser</button></div>
    </div>

    <section class="section">
      <h2>Créer un item (photo / vidéo / PPV / live)</h2>
      <p class="help">Renseigne le prix et (optionnel) associe l’item à une créatrice pour le suivi des revenus.</p>

      <form class="form-grid" id="f">
        <div>
          <label>ID créatrice (optionnel)</label>
          <input class="input" id="creatorId" placeholder="ex: user_1234 (ou vide pour ‘creatrice-demo’)" />
        </div>

        <div>
          <label>Type</label>
          <select class="input" id="type">
            <option value="image">Image (PPV)</option>
            <option value="video">Vidéo (PPV)</option>
            <option value="ppv">PPV (texte/lien)</option>
            <option value="live">LIVE (ticket)</option>
          </select>
        </div>

        <div>
          <label>Titre</label>
          <input class="input" id="title" placeholder="ex: Live privé du samedi soir" />
        </div>

        <div>
          <label>Prix (CHF)</label>
          <input class="input" id="price" type="number" step="0.01" min="0" value="0.00" />
        </div>

        <div class="full" id="roomWrap" hidden>
          <label>Nom de salle (pour LIVE)</label>
          <input class="input" id="room" placeholder="ex: saturday-live-21h" />
        </div>

        <div class="full">
          <label>Notes privées (optionnel)</label>
          <textarea class="input" id="notes" placeholder="Infos internes (non visibles client)"></textarea>
        </div>

        <div class="full chips">
          <button type="button" class="btn" id="create">Créer l’item</button>
          <button type="button" class="btn ghost" id="reset2">Réinitialiser</button>
        </div>
      </form>
    </section>

    <section class="section">
      <h2>Récapitulatif</h2>
      <div class="card">
        <p>• <b>70% pour la créatrice</b>, 30% pour Velvet.<br/>• Pour un <b>LIVE</b>, renseigne le <b>nom de salle</b> (room).<br/>• Après création, partage l’<b>URL de paiement</b> au client.</p>
        <p><b>Exemple d’URL de paiement générée :</b><br><code id="payUrl">—</code></p>
      </div>
    </section>
  </main>

  <script>
    const $ = s=>document.querySelector(s);
    const api = (p,opt={})=>fetch(p,{headers:{'Content-Type':'application/json'},...opt});

    const typeEl = $('#type'), roomWrap = $('#roomWrap');
    typeEl.onchange = ()=>{ roomWrap.hidden = (typeEl.value!=='live'); };
    $('#reset').onclick = $('#reset2').onclick = ()=>{ $('#f').reset(); $('#payUrl').textContent='—'; roomWrap.hidden=true; };

    $('#create').onclick = async ()=>{
      const body = {
        creatorId: $('#creatorId').value.trim() || 'creatrice-demo',
        type: $('#type').value,
        title: $('#title').value.trim(),
        price: parseFloat($('#price').value||'0'),
        roomName: $('#room').value.trim() || undefined,
        notes: $('#notes').value.trim() || undefined
      };
      if(!body.title) return alert('Titre requis');
      if(isNaN(body.price)||body.price<0) return alert('Prix invalide');
      if(body.type==='live' && !body.roomName) return alert('Nom de salle requis pour un live');

      try{
        const r = await api('/api/upsert-item',{method:'POST',body:JSON.stringify(body)});
        const j = await r.json();
        if(!r.ok || !j.itemId){ alert(j.error||'Erreur création'); return; }
        const url = location.origin + '/paiement.html?itemId=' + encodeURIComponent(j.itemId);
        $('#payUrl').textContent = url;
        alert('Item créé ! URL paiement générée.');
      }catch(e){ alert('Erreur réseau'); }
    };
  </script>
</body>
</html>
