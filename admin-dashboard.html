<!DOCTYPE html><html lang="fr"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin • Dashboard ventes</title><link rel="stylesheet" href="styles.css">
<style>
.wrap{max-width:1100px;margin:7vh auto 12vh;padding:22px;background:rgba(18,18,18,.92);border-radius:18px}
table{width:100%;border-collapse:collapse;margin-top:12px}th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.09)}
.right{text-align:right}.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(233,200,122,.35);background:linear-gradient(180deg,#f4d88f,#d8b565);color:#141414;font-weight:700;cursor:pointer}
.small{font-size:.9rem;opacity:.8}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style></head><body>
<header class="header"><nav class="nav">
<a class="cta" href="index.html">Accueil</a>
<a class="cta" href="admin-items.html">Créer un item</a>
</nav></header>
<main class="wrap">
<h1>Dashboard ventes & reversements</h1>
<p class="small">Vue temps réel des ventes. Calcul auto 70% créatrice / 30% plateforme (Velvet). Tes propres ventes (Velvet) restent à 100% pour toi.</p>
<div id="sum"></div>
<table id="t"><thead><tr>
<th>Créatrice</th><th class="right">Ventes (CHF)</th><th class="right">Pour elle (70%)</th><th class="right">Pour Velvet (30%)</th><th class="right">Impayé (à verser)</th><th></th>
</tr></thead><tbody id="tb"></tbody></table>
</main>
<script>
const fmt = n => Number(n||0).toFixed(2);
async function load() {
  const r = await fetch('/api/list-ledger'); const j = await r.json();
  if(!r.ok) { document.getElementById('sum').textContent='Erreur: '+(j.error||''); return; }
  const tb = document.getElementById('tb'); tb.innerHTML='';
  let tot=0, tot70=0, tot30=0, totDue=0;
  Object.keys(j.creators||{}).forEach(id=>{
    const c=j.creators[id];
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><span class="mono">${id}</span></td>
      <td class="right">${fmt(c.total)}</td>
      <td class="right">${fmt(c.dueToCreator)}</td>
      <td class="right">${fmt(c.toVelvet)}</td>
      <td class="right">${fmt(c.unpaid)}</td>
      <td class="right">${id==='velvet'?'—':`<button class="btn" data-id="${id}">Marquer payé</button>`}</td>`;
    tb.appendChild(tr);
    tot+=c.total; tot70+=c.dueToCreator; tot30+=c.toVelvet; totDue+=c.unpaid;
  });
  document.getElementById('sum').innerHTML = `
    <div>Totaux — Ventes: <b>${fmt(tot)} CHF</b> • 70% créatrices: <b>${fmt(tot70)}</b> • 30% Velvet: <b>${fmt(tot30)}</b> • Impayés: <b>${fmt(totDue)}</b></div>`;
  tb.querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = async ()=>{
      const id=b.getAttribute('data-id');
      if(!confirm('Valider le paiement à '+id+' ?')) return;
      const r = await fetch('/api/mark-paid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({creatorId:id})});
      if(r.ok) load(); else alert('Erreur'); };
  });
}
load();
</script>
</body></html>
