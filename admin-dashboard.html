<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Velvet â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/admin.css" />
  <style>
    /* filet minimal au cas oÃ¹ admin.css ne charge pas */
    body{margin:0;display:flex;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0b0d;color:#f6f6f6}
    .sidebar{width:250px;min-height:100vh;background:#0f0f12;border-right:1px solid #212129;padding:18px 16px;position:sticky;top:0}
    .sidebar h2{margin:0 0 10px;font-weight:700;letter-spacing:.6px}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .nav a{display:block;padding:10px 12px;border-radius:10px;color:#ddd;text-decoration:none;background:#131318;border:1px solid #1f1f26}
    .nav a.active,.nav a:hover{border-color:#8a6d2f;color:#f7f0da;box-shadow:0 0 0 1px #4b3a18 inset}
    .foot{margin-top:auto;font-size:12px;color:#9a9aa3}
    .main{flex:1;min-height:100vh;padding:18px 18px 80px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input{background:#111114;border:1px solid #23232b;color:#eee;border-radius:10px;padding:10px 12px;min-width:220px}
    .btn{background:#1a1a1f;border:1px solid #2b2b33;color:#eee;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:hover{border-color:#8a6d2f}
    .btn.ghost{background:transparent}
    .btn.warn{border-color:#b88700}
    .btn.danger{border-color:#b03a3a}
    .chip{background:#121219;border:1px solid #24242c;color:#bfbfcc;border-radius:999px;padding:6px 10px;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:#101015;border:1px solid #212129;border-radius:14px;padding:14px}
    .card h3{margin:0 0 6px;font-size:14px;color:#cfcfdb;font-weight:600}
    .card .value{font-size:26px;font-weight:700}
    .card .value.bad{color:#f2c66d}
    .section{margin-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#0f0f14;border:1px solid #212129;border-radius:12px;overflow:hidden}
    thead th{background:#111117;color:#cfcfdb;text-align:left;font-weight:600;padding:10px;border-bottom:1px solid #1f1f26}
    tbody td{padding:10px;border-top:1px solid #17171d}
    tbody tr:hover{background:#12121a}
    .small{margin-top:24px;color:#9a9aa3;font-size:12px}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>VELVET ADMIN</h2>
    <nav class="nav">
      <a class="active" href="#overview">ðŸ“Š AperÃ§u</a>
      <a href="/admin-users.html">ðŸ‘¤ Comptes</a>
      <a href="#sales">ðŸ’³ Ventes</a>
      <a href="#convs">ðŸ’¬ Conversations</a>
      <a href="#lives">ðŸŽ¥ Lives</a>
      <a href="/admin-items.html">âž• CrÃ©er un item</a>
    </nav>
    <div class="foot">Â© Velvet Creators VIP</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <input id="q" class="input" type="text" placeholder="Rechercher (pseudo, email)" />
        <button class="btn" id="btnFilter">Filtrer</button>
      </div>
      <div class="chips">
        <span class="chip" id="clock">--:--:--</span>
        <button class="btn" id="btnPurge">Purger inactifs (90 j)</button>
        <button class="btn" id="btnReload">RafraÃ®chir</button>
      </div>
    </div>

    <!-- OVERVIEW -->
    <section class="section" id="overview" data-tab>
      <div class="grid">
        <div class="card"><h3>Utilisateurs en ligne</h3><div class="value" id="k-online">0</div><small>dans les 5 derniÃ¨res minutes</small></div>
        <div class="card"><h3>Inscriptions en attente</h3><div class="value" id="k-pending">0</div><small>Ã  valider</small></div>
        <div class="card"><h3>Ventes (aujourdâ€™hui)</h3><div class="value" id="k-today">0.00 CHF</div><small>tickets &amp; PPV</small></div>
        <div class="card"><h3>ImpayÃ© total</h3><div class="value bad" id="k-due">0.00 CHF</div><small>Ã  verser aux crÃ©atrices</small></div>
      </div>

      <div class="section">
        <h2>DerniÃ¨res ventes</h2>
        <table id="t-last">
          <thead><tr><th>Date</th><th>CrÃ©atrice</th><th>Type</th><th>Montant</th><th>Client</th><th>Action</th></tr></thead>
          <tbody><tr><td colspan="6">Chargementâ€¦</td></tr></tbody>
        </table>
      </div>

      <div class="section">
        <h2>RÃ©cap ventes par crÃ©atrice</h2>
        <table id="t-creators">
          <thead><tr><th>CrÃ©atrice</th><th>Ventes (CHF)</th><th>Pour elle (70%)</th><th>Pour Velvet (30%)</th><th>ImpayÃ©</th><th>Action</th></tr></thead>
          <tbody><tr><td colspan="6">Chargementâ€¦</td></tr></tbody>
        </table>
        <button class="btn" id="btnCsv" style="margin-top:10px">Exporter CSV</button>
      </div>
    </section>

    <!-- SALES -->
    <section class="section" id="sales" data-tab hidden>
      <h2>DÃ©tail des ventes</h2>
      <table id="t-ledger">
        <thead><tr><th>Date</th><th>CrÃ©atrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="8">Chargementâ€¦</td></tr></tbody>
      </table>
    </section>

    <!-- CONVERSATIONS -->
    <section class="section" id="convs" data-tab hidden>
      <h2>Conversations (aperÃ§u)</h2>
      <table id="t-conv">
        <thead><tr><th>Date</th><th>Participants</th><th>Dernier message</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="4">Chargementâ€¦</td></tr></tbody>
      </table>
    </section>

    <!-- LIVES -->
    <section class="section" id="lives" data-tab hidden>
      <h2>Lives</h2>
      <table id="t-lives">
        <thead><tr><th>Room</th><th>CrÃ©atrice</th><th>Statut</th><th>Viewers</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="5">Chargementâ€¦</td></tr></tbody>
      </table>
    </section>

    <footer class="small">Besoin dâ€™un filtre/onglet en plus ? Disâ€‘moi et je lâ€™ajoute.</footer>
  </main>

  <script>
    const $  = (s, c=document) => c.querySelector(s);
    const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
    const api = (p,opt={}) => fetch(p,{headers:{'Content-Type':'application/json'}, ...opt});
    const fmt = n => Number(n||0).toFixed(2);

    // Horloge + auto-refresh
    setInterval(()=>{ const el=$('#clock'); if(el) el.textContent=new Date().toLocaleTimeString(); }, 1000);
    setInterval(()=>reloadAll(), 30000);

    // Tabs
    function activateFromHash(){
      const hash = location.hash || '#overview';
      $$('.nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href')===hash));
      $$('[data-tab]').forEach(sec => { sec.hidden = ('#'+sec.id !== hash); });
      const el = $(hash); if(el) el.scrollIntoView({block:'start'});
    }
    window.addEventListener('hashchange', activateFromHash);
    document.addEventListener('DOMContentLoaded', activateFromHash);

    // Rendus
    function renderLast(rows=[]){
      const tb = $('#t-last tbody'); if(!tb) return;
      tb.innerHTML='';
      if (!rows.length){ tb.innerHTML = '<tr><td colspan="6">Aucune vente.</td></tr>'; return; }
      rows.slice(0,8).forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'â€”'}</td>
          <td>${v.type||'â€”'}</td>
          <td>${fmt(v.amount)} CHF</td>
          <td>${v.clientEmail||'â€”'}</td>
          <td>${v.paid ? 'PayÃ©' : `<button class="btn" data-pay="${v.id||''}">Marquer payÃ©</button>`}</td>`;
        tb.appendChild(tr);
      });
    }
    function renderCreators(map={}){
      const tb = $('#t-creators tbody'); if(!tb) return;
      tb.innerHTML='';
      const entries = Object.entries(map);
      if (!entries.length){ tb.innerHTML = '<tr><td colspan="6">Aucune donnÃ©e.</td></tr>'; return; }
      entries.forEach(([name,val])=>{
        const total = Number(val.total||0), c70=total*0.7, v30=total*0.3, due=Number(val.due||0);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${fmt(total)}</td><td>${fmt(c70)}</td><td>${fmt(v30)}</td>
                        <td>${fmt(due)}</td>
                        <td>${due>0 ? `<button class="btn" data-bulk="${name}">Marquer tout payÃ©</button>` : 'â€”'}</td>`;
        tb.appendChild(tr);
      });
    }
    function renderLedger(rows=[]){
      const tb = $('#t-ledger tbody'); if(!tb) return;
      tb.innerHTML='';
      if (!rows.length){ tb.innerHTML = '<tr><td colspan="8">Aucune ligne.</td></tr>'; return; }
      rows.forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${(v.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${v.creator||'â€”'}</td>
          <td>${v.type||'â€”'}</td>
          <td>${fmt(v.amount)}</td>
          <td>${v.txn||'â€”'}</td>
          <td>${v.clientEmail||'â€”'}</td>
          <td>${v.paid ? 'PayÃ©' : 'ImpayÃ©'}</td>
          <td>${v.paid ? 'â€”' : `<button class="btn" data-pay="${v.id||''}">PayÃ©</button>`}</td>`;
        tb.appendChild(tr);
      });
    }
    function renderConvs(rows=[]){
      const tb = $('#t-conv tbody'); if(!tb) return;
      tb.innerHTML='';
      if (!rows.length){ tb.innerHTML = '<tr><td colspan="4">Aucune donnÃ©e.</td></tr>'; return; }
      rows.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${(c.date||'').replace('T',' ').slice(0,16)}</td>
          <td>${(c.participants||[]).join(', ')||'â€”'}</td>
          <td>${c.lastMessage||'â€”'}</td>
          <td><a class="btn" href="/admin-users.html?q=${encodeURIComponent(c.participants?.[0]||'')}">Ouvrir</a></td>`;
        tb.appendChild(tr);
      });
    }
    function renderLives(rows=[]){
      const tb = $('#t-lives tbody'); if(!tb) return;
      tb.innerHTML='';
      if (!rows.length){ tb.innerHTML = '<tr><td colspan="5">Aucun live.</td></tr>'; return; }
      rows.forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${l.room||'â€”'}</td><td>${l.creator||'â€”'}</td>
          <td>${l.status||'â€”'}</td><td>${l.viewers ?? 'â€”'}</td>
          <td>${l.adminUrl ? `<a class="btn" target="_blank" href="${l.adminUrl}">Ouvrir</a>` : 'â€”'}</td>`;
        tb.appendChild(tr);
      });
    }

    // Chargements
    async function loadLedger(){
      try{
        const r = await api('/api/list-ledger');
        const j = await r.json();
        $('#k-online')  && ($('#k-online').textContent  = j.online ?? 0);
        $('#k-pending') && ($('#k-pending').textContent = j.pending ?? 0);
        $('#k-today')   && ($('#k-today').textContent   = (j.totals?.today ?? 0).toFixed(2)+' CHF');
        $('#k-due')     && ($('#k-due').textContent     = (j.totals?.due   ?? 0).toFixed(2)+' CHF');
        renderLast(j.last||[]);
        renderCreators(j.creators||{});
        renderLedger(j.ledger||[]);
      }catch(e){ /* silencieux */ }
    }
    async function loadConversations(){
      try{
        const r = await api('/api/list-conversations'); if (!r.ok) throw 0;
        renderConvs((await r.json()).items||[]);
      }catch{ const tb=$('#t-conv tbody'); if(tb) tb.innerHTML='<tr><td colspan="4">Indisponible.</td></tr>'; }
    }
    async function loadLives(){
      try{
        const r = await api('/api/list-lives'); if (!r.ok) throw 0;
        renderLives((await r.json()).items||[]);
      }catch{ const tb=$('#t-lives tbody'); if(tb) tb.innerHTML='<tr><td colspan="5">Indisponible.</td></tr>'; }
    }

    // Actions
    async function markPaid(id){
      try{
        const r = await api('/api/mark-paid', { method:'POST', body: JSON.stringify({ id }) });
        const j = await r.json(); if (!r.ok || !j.ok) throw 0; loadLedger();
      }catch{ alert('Erreur marquage payÃ©'); }
    }
    async function markAllForCreator(name){
      if (!confirm('Marquer TOUT impayÃ© comme versÃ© pour cette crÃ©atrice ?')) return;
      try{
        const r = await api('/api/mark-paid', { method:'POST', body: JSON.stringify({ id: 'creator:'+name }) });
        const j = await r.json(); if (!r.ok || !j.ok) throw 0; loadLedger();
      }catch{ alert('Erreur marquage global'); }
    }
    async function purgeInactive90d(){
      if (!confirm('Supprimer les comptes inactifs depuis 90 jours ?')) return;
      try{
        const r = await api('/api/purge-inactive', { method:'POST' });
        const j = await r.json(); if (!r.ok || !j.ok) throw 0; alert('Comptes supprimÃ©s : ' + (j.count||0));
      }catch{ alert('Erreur purge'); }
    }
    function exportCsv(){ window.location.href = '/api/list-ledger?format=csv'; }

    document.addEventListener('click', (e)=>{
      const bPay  = e.target.closest('button[data-pay]');
      const bBulk = e.target.closest('button[data-bulk]');
      if (bPay)  markPaid(bPay.dataset.pay);
      if (bBulk) markAllForCreator(bBulk.dataset.bulk);
    });
    $('#btnReload').onclick = ()=>{ loadLedger(); loadConversations(); loadLives(); };
    $('#btnPurge').onclick  = purgeInactive90d;
    $('#btnCsv').onclick    = exportCsv;
    $('#btnFilter').onclick = ()=>{ const q=($('#q')?.value||'').trim(); location.href='/admin-users.html'+(q?('?q='+encodeURIComponent(q)):''); };

    // Init
    function reloadAll(){ loadLedger(); loadConversations(); loadLives(); }
    reloadAll();
  </script>
</body>
</html>
