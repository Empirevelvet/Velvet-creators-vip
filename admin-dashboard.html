<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äî Velvet (admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- STYLE int√©gr√© : sombre, lisible, 100% responsive -->
  <style>
    :root{
      --bg:#0f1115; --panel:#171a22; --soft:#1f2433; --text:#e9edf4; --muted:#9aa4b2;
      --brand:#7b5cff; --brand2:#12d1b7; --ok:#24d180; --warn:#ffcc00; --danger:#ff5470;
      --line:#23293a; --chip:#1b2130; --thead:#121827;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    a:hover{opacity:.9;text-decoration:underline}

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(7,8,11,.7),rgba(7,8,11,.2));backdrop-filter:blur(8px)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 16px}
    .h1{font-weight:800;font-size:clamp(20px,2.5vw,28px);letter-spacing:.3px;margin:6px 0 2px}
    .sub{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .actions a,.actions button{background:var(--chip);border:1px solid var(--line);color:var(--text);padding:9px 12px;border-radius:10px;font-weight:700;font-size:13px}
    .actions a:hover,.actions button:hover{background:#20283a}

    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;margin:16px auto}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg,#151a24,#121723);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:16px}
    .help{color:var(--muted);font-size:12px;margin:-2px 0 12px}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 16px}
    @media (max-width:820px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{background:#101626;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .l{color:var(--muted);font-size:12px}
    .kpi .v{font-size:22px;font-weight:800;margin-top:6px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .toolbar select,.toolbar input{background:#0f141e;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 10px}
    .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn);color:#141208} .btn.danger{background:var(--danger)}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}

    .tablewrap{border:1px solid var(--line);border-radius:12px;overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:760px}
    thead th{position:sticky;top:0;background:var(--thead);color:#aeb7d0;text-align:left;padding:10px 12px;border-bottom:1px solid var(--line);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#151b2a}
    .right{text-align:right}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:var(--chip);color:var(--text)}
    .chip.ok{background:rgba(36,209,128,.12);border-color:rgba(36,209,128,.35);color:#9ff2cf}
    .chip.warn{background:rgba(255,204,0,.12);border-color:rgba(255,204,0,.35);color:#ffe38a}
    .chip.bad{background:rgba(255,84,112,.12);border-color:rgba(255,84,112,.35);color:#ff9eaa}
    .chip.role{background:#101b2b;border-color:#27364f;color:#9bbcff}
    .muted{color:var(--muted)}

    .toast{position:fixed;right:16px;bottom:16px;display:none;background:#0f1726;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:700;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .hr{height:1px;background:var(--line);margin:16px 0}

    /* Mobile table cards */
    @media (max-width:640px){
      table, thead, tbody, th, td, tr{display:block;width:100%}
      thead{display:none}
      tbody tr{padding:10px 12px}
      tbody td{border:none;padding:6px 0}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="h1">Velvet ‚Äî Dashboard (admin)</div>
      <div class="sub">Mod√©rer les comptes, suivre les ventes, marquer les versements.</div>
      <div class="actions">
        <a href="/index.html">üè† Accueil</a>
        <a href="/admin-items.html">‚ûï Cr√©er un item</a>
        <button id="btnReload" class="btn small ghost">Rafra√Æchir</button>
        <span id="msg" class="muted"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- COMPTES -->
      <section class="card">
        <h2>Comptes ‚Äî valider / suspendre / supprimer</h2>
        <div class="help">‚ÄúSuspendre‚Äù bloque l‚Äôacc√®s sans supprimer les donn√©es. Tu peux r√©activer ensuite.</div>

        <div class="toolbar">
          <select id="fStatus">
            <option value="">Statut : Tous</option>
            <option value="pending">En attente</option>
            <option value="active">Actif</option>
            <option value="suspended">Suspendu</option>
          </select>
          <select id="fRole">
            <option value="">R√¥le : Tous</option>
            <option value="creator">Cr√©atrices</option>
            <option value="client">Clients</option>
            <option value="admin">Admins</option>
          </select>
          <input id="fQuery" placeholder="üîé pseudo / email" />
          <button id="refreshUsers" class="btn small ghost">Rafra√Æchir</button>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr><th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th class="right">Action</th></tr>
            </thead>
            <tbody id="tbUsers">
              <tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- KPIs + R√âCAP CR√âATRICES -->
      <section class="card">
        <h2>Ventes & r√©partition (70% / 30%)</h2>
        <div class="help">Clique sur <b>‚ÄúMarquer pay√©‚Äù</b> apr√®s ton virement PayPal √† la cr√©atrice.</div>

        <div class="kpis">
          <div class="kpi"><div class="l">Ventes (CHF)</div><div class="v" id="kTot">‚Äî</div></div>
          <div class="kpi"><div class="l">Pour cr√©atrices (70%)</div><div class="v" id="k70">‚Äî</div></div>
          <div class="kpi"><div class="l">Pour Velvet (30%)</div><div class="v" id="k30">‚Äî</div></div>
          <div class="kpi"><div class="l">Impay√© total</div><div class="v" id="kUnpaid">‚Äî</div></div>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Cr√©atrice</th><th class="right">Ventes (CHF)</th>
                <th class="right">Pour elle (70%)</th><th class="right">Pour Velvet (30%)</th>
                <th class="right">Impay√©</th><th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="tbCreators">
              <tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
          <button id="exportCsv" class="btn small ghost">Exporter CSV</button>
          <button id="refreshLedger" class="btn small ghost">Rafra√Æchir</button>
        </div>
      </section>
    </div>

    <!-- D√âTAIL DES VENTES -->
    <section class="card">
      <h2>D√©tail des ventes</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="right">Montant</th>
              <th>Txn</th><th>Email client</th><th>Statut</th>
            </tr>
          </thead>
          <tbody id="tbSales">
            <tr><td colspan="7" class="muted">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- LOGIQUE int√©gr√©e : appels API + rendu + actions -->
  <script>
    // ---------- Helpers ----------
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];
    const fmt = n => Number(n||0).toFixed(2).replace('.', ',');
    const toast = (t, ok=true)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; el.style.borderColor= ok ? "#214c36" : "#5e2020"; setTimeout(()=>el.style.display="none", 2200); };
    const setMsg = (t, ok=true)=>{ const el=$("#msg"); el.textContent=t||""; el.style.color = ok ? "#8ff0b4" : "#ff9aa0"; setTimeout(()=>el.textContent="", 3000); };

    async function api(url, opt){ const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opt }); let j=null; try{ j=await r.json(); }catch{} return {ok:r.ok, status:r.status, data:j}; }

    // ---------- USERS ----------
    let USERS = [];

    async function loadUsers(){
      $("#tbUsers").innerHTML = `<tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>`;
      const r = await api('/api/list-users');
      if(!r.ok){ $("#tbUsers").innerHTML = `<tr><td colspan="6" class="muted">Erreur chargement utilisateurs</td></tr>`; return; }
      USERS = r.data?.users || r.data || [];
      renderUsers();
    }

    function renderUsers(){
      const st = $("#fStatus").value, role = $("#fRole").value, q = ($("#fQuery").value||"").toLowerCase();
      const rows = USERS.filter(u=>{
        const okS = !st || (u.status||'pending')===st;
        const okR = !role || (u.role||'client')===role;
        const okQ = !q || (String(u.username||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q));
        return okS && okR && okQ;
      }).map(u=>{
        const badge = (u.status==='active')?'ok':(u.status==='suspended'?'warn':'bad');
        const d = new Date(u.createdAt || u.created || Date.now()).toLocaleString();
        const idOrEmail = u.email || u.id;
        return `<tr>
          <td>${d}</td>
          <td>${u.username||'‚Äî'}</td>
          <td class="muted">${u.email||'‚Äî'}</td>
          <td><span class="chip role">${u.role||'client'}</span></td>
          <td><span class="chip ${badge}">${u.status||'pending'}</span></td>
          <td class="right row-actions">
            ${u.status!=='active'
              ? `<button class="btn small ok" data-act="unsuspend" data-id="${idOrEmail}">Activer</button>`
              : `<button class="btn small warn" data-act="suspend" data-id="${idOrEmail}">Suspendre</button>`}
            <button class="btn small danger" data-act="delete" data-id="${idOrEmail}">Supprimer</button>
          </td>
        </tr>`;
      }).join('');
      $("#tbUsers").innerHTML = rows || `<tr><td colspan="6" class="muted">Aucun compte.</td></tr>`;
    }

    // Actions sur comptes
    $("#tbUsers").addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-act]'); if(!b) return;
      const id = b.dataset.id; const act = b.dataset.act;
      if(act==='suspend'){
        const reason = prompt("Motif de suspension (interne) :",""); if(reason===null) return;
        const r = await api('/api/suspend-user',{method:'POST', body:JSON.stringify({ id, reason })});
        r.ok ? (toast('Compte suspendu'), loadUsers()) : toast('Erreur suspension', false);
      }else if(act==='unsuspend'){
        const r = await api('/api/unsuspend-user',{method:'POST', body:JSON.stringify({ id })});
        r.ok ? (toast('Compte activ√©'), loadUsers()) : toast('Erreur activation', false);
      }else if(act==='delete'){
        if(!confirm('Supprimer d√©finitivement ce profil ?')) return;
        const r = await api('/api/delete-user',{method:'POST', body:JSON.stringify({ id })});
        r.ok ? (toast('Profil supprim√©'), loadUsers()) : toast('Erreur suppression', false);
      }
    });

    $("#refreshUsers").onclick = loadUsers;
    $("#fStatus").onchange = renderUsers;
    $("#fRole").onchange = renderUsers;
    $("#fQuery").oninput = ()=>{ clearTimeout(window.__q); window.__q=setTimeout(renderUsers,160); };

    // ---------- LEDGER ----------
    let LEDGER = { totals:{}, creators:{}, sales:[] };

    async function loadLedger(){
      $("#tbCreators").innerHTML = `<tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>`;
      $("#tbSales").innerHTML = `<tr><td colspan="7" class="muted">Chargement‚Ä¶</td></tr>`;
      const r = await api('/api/list-ledger');
      if(!r.ok){ $("#tbCreators").innerHTML = `<tr><td colspan="6" class="muted">Erreur ledger</td></tr>`; $("#tbSales").innerHTML = `<tr><td colspan="7" class="muted">Erreur ledger</td></tr>`; return; }

      // Accepte 2 formats: { totals, creators, sales } OU array ventes
      if (Array.isArray(r.data)) {
        const sales = r.data;
        const total = sales.reduce((a,s)=>a+Number(s.amount||0),0);
        LEDGER = {
          totals:{ total, toCreators: total*0.70, toVelvet: total*0.30, unpaid: 0 },
          creators:{},
          sales
        };
      } else {
        LEDGER = {
          totals: r.data.totals || {},
          creators: r.data.creators || {},
          sales: r.data.sales || []
        };
      }
      renderLedger();
    }

    function renderLedger(){
      const t = LEDGER.totals || {};
      $("#kTot").textContent = fmt(t.total||0) + " CHF";
      $("#k70").textContent  = fmt(t.toCreators||0) + " CHF";
      $("#k30").textContent  = fmt(t.toVelvet||0) + " CHF";
      $("#kUnpaid").textContent = fmt(t.unpaid||0) + " CHF";

      // Cr√©atrices
      const cs = Object.values(LEDGER.creators||{});
      $("#tbCreators").innerHTML = cs.length ? cs.map(c=>{
        const unpaid = Number(c.unpaid ?? ((c.toCreator||0) - (c.alreadyPaid||0)));
        return `<tr>
          <td>${c.name||c.id||'‚Äî'}</td>
          <td class="right">${fmt(c.total||0)}</td>
          <td class="right">${fmt(c.toCreator||0)}</td>
          <td class="right">${fmt(c.toVelvet||0)}</td>
          <td class="right">${unpaid>0?`<span class="chip warn">${fmt(unpaid)}</span>`:`<span class="chip ok">0,00</span>`}</td>
          <td class="right">
            ${unpaid>0?`<button class="btn small ok" data-mark="${c.id}">Marquer pay√©</button>`:'‚Äî'}
          </td>
        </tr>`;
      }).join('') : `<tr><td colspan="6" class="muted">Pas encore de ventes.</td></tr>`;

      // Ventes
      const rows = (LEDGER.sales||[]).map(s=>{
        const d = new Date(s.date||Date.now()).toLocaleString();
        const badge = (s.status==='paid')?'ok':'warn';
        return `<tr>
          <td>${d}</td>
          <td>${s.creatorName||s.creatorId||'‚Äî'}</td>
          <td><span class="chip">${s.type||'ppv'}</span></td>
          <td class="right">${fmt(s.amount||0)}</td>
          <td class="muted">${s.txn||'‚Äî'}</td>
          <td class="muted">${s.buyerEmail||'‚Äî'}</td>
          <td><span class="chip ${badge}">${s.status||'pending'}</span></td>
        </tr>`;
      }).join('');
      $("#tbSales").innerHTML = rows || `<tr><td colspan="7" class="muted">Aucune vente.</td></tr>`;
    }

    // Marquer pay√© (par cr√©atrice)
    $("#tbCreators").addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-mark]'); if(!b) return;
      const creatorId = b.dataset.mark;
      if(!confirm('Confirmer : marquer PAY√â pour cette cr√©atrice ?')) return;
      const r = await api('/api/mark-paid', { method:'POST', body:JSON.stringify({ creatorId }) });
      r.ok ? (toast('Marqu√© pay√©'), loadLedger()) : toast('Erreur ‚Äúmarqu√© pay√©‚Äù', false);
    });

    // Export CSV (ventes)
    $("#exportCsv").onclick = ()=>{
      const rows = [['date','creator','type','amount','txn','buyerEmail','status']];
      (LEDGER.sales||[]).forEach(s=>{
        rows.push([
          new Date(s.date||Date.now()).toISOString(),
          (s.creatorName||s.creatorId||'').replaceAll(';',' '),
          s.type||'ppv',
          String(Number(s.amount||0).toFixed(2)).replace('.',','),
          (s.txn||'').replaceAll(';',' '),
          (s.buyerEmail||'').replaceAll(';',' '),
          s.status||'pending'
        ]);
      });
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `velvet_ventes_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    };

    // Actions globales
    $("#refreshLedger").onclick = loadLedger;
    $("#btnReload").onclick = ()=>{ loadUsers(); loadLedger(); };

    // Boot
    loadUsers(); loadLedger();
  </script>
</body>
</html>
