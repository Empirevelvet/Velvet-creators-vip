<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Velvet ‚Äî Dashboard admin</title>

<!-- STYLE LOCAL AU DASHBOARD -->
<style>
:root{
  --bg:#0f1115; --panel:#171a22; --muted:#a9b0c3; --text:#e9ecf5;
  --brand:#7b5cff; --brand-2:#00d1b2; --warn:#ffcc00; --danger:#ff5470; --ok:#24d180;
  --line:#232838; --chip:#1f2433;
}
*{box-sizing:border-box}
html,body{background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";}
a{color:var(--brand); text-decoration:none}
a:hover{text-decoration:underline}
.wrap{max-width:1100px; margin:20px auto; padding:20px;}
.header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
.breadcrumbs{color:var(--muted); font-size:13px}
.h1{font-size:24px; font-weight:800; letter-spacing:.2px}
.actions a{display:inline-block; background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; margin-left:8px}
.panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:18px; margin:16px 0; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.panel h2{margin:0 0 12px; font-size:16px; letter-spacing:.3px}
.help{color:var(--muted); font-size:12px; margin:4px 0 14px}

.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:6px 0 18px}
.kpi{background:linear-gradient(180deg,var(--panel),#141823); border:1px solid var(--line); border-radius:14px; padding:14px}
.kpi .label{color:var(--muted); font-size:12px}
.kpi .value{font-size:22px; font-weight:800; margin-top:6px}
.kpi .tag{display:inline-block; margin-top:6px; padding:4px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:var(--muted)}

.filters{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
select,input[type="text"],button.btn{background:#121520; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-weight:600}
input::placeholder{color:#66708a}
button.btn{cursor:pointer; transition:.18s transform ease}
button.btn:hover{transform:translateY(-1px)}
.btn.brand{background:var(--brand); border-color:transparent}
.btn.ghost{background:transparent}
.btn.warn{background:var(--warn); color:#1b1d22; border-color:transparent}
.btn.danger{background:var(--danger); border-color:transparent}
.btn.ok{background:var(--ok); border-color:transparent; color:#0e1418}
.btn.small{padding:6px 10px; font-size:12px; border-radius:8px}

.table-wrap{border:1px solid var(--line); border-radius:14px; overflow:hidden}
table{width:100%; border-collapse:collapse; font-size:13px}
thead th{background:#121520; color:#9fb0ff; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line); letter-spacing:.2px}
tbody td{padding:10px 12px; border-bottom:1px solid var(--line)}
tbody tr:hover{background:#131826}
.meta{color:var(--muted)}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:800}
.badge.green{background:#10251b; color:#25d28a}
.badge.yellow{background:#2a240d; color:#ffd35a}
.badge.red{background:#2a1318; color:#ff6a7a}
.badge.blue{background:#101b2b; color:#7ca7ff}
.badge.gray{background:var(--chip); color:var(--muted)}
.t-right{text-align:right}
.row-actions{display:flex; gap:6px; flex-wrap:wrap}
hr.sep{border:none; height:1px; background:var(--line); margin:18px 0}

/* responsive */
@media (max-width:1024px){ .kpis{grid-template-columns:repeat(2,1fr)} }
@media (max-width:620px){
  .wrap{padding:14px}
  .kpis{grid-template-columns:1fr}
  thead{display:none}
  table,tbody,tr,td{display:block; width:100%}
  tbody tr{padding:10px 12px}
  tbody td{border:none; padding:6px 0}
  .t-right{text-align:left}
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="breadcrumbs">Dashboard ‚Üí <b>Velvet (admin)</b></div>
        <div class="h1">Pilotage de la plateforme</div>
      </div>
      <div class="actions">
        <a href="index.html">Accueil</a>
        <a href="admin-items.html">Cr√©er un item</a>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Ventes (CHF)</div><div class="value" id="k_total">‚Äî</div><div class="tag">Toutes p√©riodes</div></div>
      <div class="kpi"><div class="label">Pour cr√©atrices (70%)</div><div class="value" id="k_c70">‚Äî</div><div class="tag">√Ä verser</div></div>
      <div class="kpi"><div class="label">Pour Velvet (30%)</div><div class="value" id="k_v30">‚Äî</div><div class="tag">Commission</div></div>
      <div class="kpi"><div class="label">Impay√©</div><div class="value" id="k_unpaid">‚Äî</div><div class="tag">Solde non pay√©</div></div>
    </div>

    <!-- Comptes -->
    <section class="panel">
      <h2>Comptes ‚Äî <span class="meta">valider / suspendre / supprimer</span></h2>
      <p class="help">‚ÄúSuspendre‚Äù bloque l‚Äôacc√®s sans supprimer les donn√©es. Les motifs sont enregistr√©s.</p>

      <div class="filters">
        <label>Status
          <select id="f_status">
            <option value="">Tous</option>
            <option value="pending">En attente</option>
            <option value="active">Actif</option>
            <option value="suspended">Suspendu</option>
          </select>
        </label>
        <label>R√¥le
          <select id="f_role">
            <option value="">Tous</option>
            <option value="creator">Cr√©atrice</option>
            <option value="client">Client</option>
          </select>
        </label>
        <input type="text" id="f_q" placeholder="üîé pseudo / email" />
        <button class="btn small ghost" id="refreshUsers">Rafra√Æchir</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody id="tb_users">
            <tr><td colspan="6" class="meta">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- R√©partition -->
    <section class="panel">
      <h2>Ventes & r√©partition (70% / 30%)</h2>
      <p class="help">Clique sur <b>‚ÄúMarquer pay√©‚Äù</b> quand tu as fait le virement PayPal √† la cr√©atrice.</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cr√©atrice</th><th class="t-right">Ventes (CHF)</th>
              <th class="t-right">Pour elle (70%)</th><th class="t-right">Pour Velvet (30%)</th>
              <th class="t-right">Impay√©</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="tb_creators">
            <tr><td colspan="6" class="meta">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px;">
        <button id="exportCsv" class="btn ghost small">Exporter CSV</button>
        <button id="refreshLedger" class="btn ghost small">Rafra√Æchir</button>
      </div>
    </section>

    <!-- D√©tail des ventes -->
    <section class="panel">
      <h2>D√©tail des ventes</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="t-right">Montant</th>
              <th>Txn</th><th>Email client</th><th>Status</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="tb_sales">
            <tr><td colspan="8" class="meta">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <hr class="sep"/>

    <p class="meta">Besoin d‚Äôune autre vue / filtres (par p√©riode, par cr√©atrice) ? Dis‚Äëmoi ce que tu veux et je te le mets.</p>
  </div>

<!-- LOGIQUE -->
<script>
const $ = (id)=>document.getElementById(id);
const fmtCHF = (n)=> (Number(n||0)).toFixed(2).replace('.', ',');

/* ---------- Comptes ---------- */
let USERS_RAW = [];
async function loadUsers(){
  $('tb_users').innerHTML = `<tr><td colspan="6" class="meta">Chargement‚Ä¶</td></tr>`;
  const r = await fetch('/api/list-users'); const j = await r.json();
  USERS_RAW = Array.isArray(j.users) ? j.users : [];
  renderUsers();
}
function renderUsers(){
  const status = $('f_status').value, role = $('f_role').value, q = $('f_q').value.toLowerCase();
  const rows = USERS_RAW.filter(u=>{
    const okS = !status || u.status===status;
    const okR = !role || u.role===role;
    const okQ = !q || (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q);
    return okS && okR && okQ;
  }).map(u=>{
    const badge = u.status==='active' ? 'green' : u.status==='pending' ? 'yellow' : 'red';
    const roleB = u.role==='creator' ? 'blue' : 'gray';
    return `<tr>
      <td>${new Date(u.createdAt||u.created||Date.now()).toLocaleDateString()}</td>
      <td>${u.username||'‚Äî'}</td>
      <td class="meta">${u.email||'‚Äî'}</td>
      <td><span class="badge ${roleB}">${u.role||'‚Äî'}</span></td>
      <td><span class="badge ${badge}">${u.status||'‚Äî'}</span></td>
      <td class="row-actions">
        ${u.status!=='active' ? `<button class="btn small ok" data-act="unsuspend" data-id="${u.id||u.email}">Activer</button>` : `<button class="btn small warn" data-act="suspend" data-id="${u.id||u.email}">Suspendre</button>`}
        <button class="btn small danger" data-act="delete" data-id="${u.id||u.email}">Supprimer</button>
      </td>
    </tr>`;
  }).join('');
  $('tb_users').innerHTML = rows || `<tr><td colspan="6" class="meta">Aucun compte.</td></tr>`;
}
$('refreshUsers').onclick = loadUsers;
$('f_status').onchange = renderUsers; $('f_role').onchange = renderUsers; $('f_q').oninput = renderUsers;

document.addEventListener('click', async (e)=>{
  const b = e.target.closest('button[data-act]'); if(!b) return;
  const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
  if(act==='delete' && !confirm('Supprimer ce profil ?')) return;
  const url = act==='suspend' ? '/api/suspend-user' : act==='unsuspend' ? '/api/unsuspend-user' : '/api/delete-user';
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ id }) });
  const j = await r.json();
  if(!r.ok || j.ok!==true){ alert('Action impossible'); return; }
  loadUsers();
});

/* ---------- Ledger (ventes) ---------- */
let LEDGER = null;
async function loadLedger(){
  $('tb_creators').innerHTML = `<tr><td colspan="6" class="meta">Chargement‚Ä¶</td></tr>`;
  $('tb_sales').innerHTML = `<tr><td colspan="8" class="meta">Chargement‚Ä¶</td></tr>`;
  const r = await fetch('/api/list-ledger'); LEDGER = await r.json();

  const t = LEDGER.totals || {};
  $('k_total').textContent = fmtCHF(t.total||0);
  $('k_c70').textContent   = fmtCHF(t.toCreators||0);
  $('k_v30').textContent   = fmtCHF(t.toVelvet||0);
  $('k_unpaid').textContent= fmtCHF(t.unpaid||0);

  // recap par cr√©atrice
  const creators = LEDGER.creators || {};
  const rows = Object.values(creators).map(c=>{
    const unpaid = Number(c.unpaid||0);
    return `<tr>
      <td>${c.name||c.id||'‚Äî'}</td>
      <td class="t-right">${fmtCHF(c.total||0)}</td>
      <td class="t-right">${fmtCHF(c.toCreator||0)}</td>
      <td class="t-right">${fmtCHF(c.toVelvet||0)}</td>
      <td class="t-right">${unpaid>0?`<span class="badge yellow">${fmtCHF(unpaid)}</span>`:`<span class="badge green">0,00</span>`}</td>
      <td>${unpaid>0?`<button class="btn small ok" data-pay="${c.id}">Marquer pay√©</button>`:'‚Äî'}</td>
    </tr>`;
  }).join('');
  $('tb_creators').innerHTML = rows || `<tr><td colspan="6" class="meta">Aucune vente.</td></tr>`;

  // d√©tails
  const sales = Array.isArray(LEDGER.sales)? LEDGER.sales : [];
  const rows2 = sales.map(s=>{
    const badge = s.status==='paid' ? 'green' : 'yellow';
    return `<tr>
      <td>${new Date(s.date||Date.now()).toLocaleString()}</td>
      <td>${s.creatorName||s.creatorId||'‚Äî'}</td>
      <td><span class="badge blue">${s.type||'ppv'}</span></td>
      <td class="t-right">${fmtCHF(s.amount||0)}</td>
      <td class="meta">${s.txn||'‚Äî'}</td>
      <td class="meta">${s.buyerEmail||'‚Äî'}</td>
      <td><span class="badge ${badge}">${s.status||'pending'}</span></td>
      <td>‚Äî</td>
    </tr>`;
  }).join('');
  $('tb_sales').innerHTML = rows2 || `<tr><td colspan="8" class="meta">Aucune vente pour l‚Äôinstant.</td></tr>`;
}
$('refreshLedger').onclick = loadLedger;

// Marquer pay√©
document.addEventListener('click', async (e)=>{
  const pay = e.target.closest('button[data-pay]'); if(!pay) return;
  const creatorId = pay.getAttribute('data-pay');
  if(!confirm('Confirmer le marquage ‚Äúpay√©‚Äù pour cette cr√©atrice ?')) return;
  const r = await fetch('/api/mark-paid', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ creatorId }) });
  const j = await r.json(); if(!r.ok || j.ok!==true){ alert('√âchec marquage.'); return; }
  loadLedger();
});

// Export CSV
$('exportCsv').onclick = ()=>{
  if(!LEDGER || !Array.isArray(LEDGER.sales)) return;
  const head = ['date','creator','type','amount','txn','buyerEmail','status'];
  const lines = [head.join(',')].concat(LEDGER.sales.map(s=>[
    new Date(s.date||Date.now()).toISOString(),
    (s.creatorName||s.creatorId||'').replaceAll(',',' '),
    s.type||'ppv',
    String(Number(s.amount||0).toFixed(2)).replace('.',','),
    (s.txn||'').replaceAll(',',' '),
    (s.buyerEmail||'').replaceAll(',',' '),
    s.status||'pending'
  ].join(',')));
  const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'velvet-ventes.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
};

// Go
loadUsers(); loadLedger();
</script>
</body>
</html>
