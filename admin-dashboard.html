<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velvet — Dashboard admin</title>

  <!-- Style intégré : thème sombre, mobile-first -->
  <style>
    :root{
      --bg:#0f1115;--panel:#151923;--muted:#8b93a7;--text:#e6e9f2;
      --brand:#7c5cff;--ok:#28c79a;--warn:#ffb020;--danger:#ff5678;
      --line:#232836;--chip:#1b2130;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .logo{font-weight:700;font-size:18px}
    .top-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.ghost{background:var(--chip);color:var(--text)}
    .btn.small{padding:8px 10px;font-size:13px;border-radius:8px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    h1{font-size:22px;margin:4px 0 12px}
    h2{font-size:18px;margin:0 0 10px}
    .muted{color:var(--muted)}
    /* cartes KPI */
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0 4px}
    .kpi{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi label{display:block;color:var(--muted);font-size:12px}
    .kpi strong{display:block;font-size:20px;margin-top:4px}
    /* filtres */
    .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr)) 120px;gap:8px}
    .input, select{width:100%;background:#0e131d;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:10px}
    /* tables */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:10px;vertical-align:middle}
    .table th{color:var(--muted);text-align:left;font-weight:600;font-size:13px}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
    .chip.ok{background:#0d1e18;border-color:#174f3f;color:#9fe7cf}
    .chip.warn{background:#2a2211;border-color:#4b3a14;color:#ffd47a}
    .chip.danger{background:#2a1219;border-color:#4a1520;color:#ffb3c3}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn.link{background:transparent;border:1px solid var(--line);color:var(--text)}
    footer{color:var(--muted);text-align:center;padding:28px 0 12px}

    /* responsive */
    @media (max-width:820px){
      .filters{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .kpis{grid-template-columns:1fr 1fr}
      .hide-sm{display:none}
      .btn.small{padding:7px 9px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">Velvet — <span class="muted">Dashboard (admin)</span></div>
      <nav class="top-actions">
        <a class="btn ghost small" href="index.html">Accueil</a>
        <a class="btn ghost small" href="admin-items.html">Créer un item</a>
        <button id="refreshAll" class="btn small">Rafraîchir</button>
      </nav>
    </header>

    <!-- Comptes -->
    <section class="panel">
      <h1>Comptes — valider / suspendre / supprimer</h1>
      <p class="muted">“Suspendre” bloque l’accès sans supprimer les données. Les motifs sont enregistrés.</p>

      <div class="filters" style="margin:8px 0 10px">
        <select id="fStatus">
          <option value="">Statut : Tous</option>
          <option value="pending">En attente</option>
          <option value="approved">Validé</option>
          <option value="suspended">Suspendu</option>
        </select>
        <select id="fRole">
          <option value="">Rôle : Tous</option>
          <option value="creator">Créatrice</option>
          <option value="client">Client</option>
        </select>
        <input id="fQuery" class="input" placeholder="recherche (pseudo / email)" />
        <div class="kpi">
          <label>Comptes</label>
          <strong id="kpiUsers">—</strong>
        </div>
        <button id="applyUsersFilters" class="btn small">Filtrer</button>
      </div>

      <div class="table-wrap">
        <table class="table" id="usersTable">
          <thead>
            <tr>
              <th>Date</th><th>Pseudo</th><th class="hide-sm">Email</th><th>Rôle</th><th>Statut</th><th>Action</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="6" class="muted">Chargement…</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Ventes & split -->
    <section class="panel">
      <h1>Ventes & répartition (70% / 30%)</h1>
      <p class="muted">Clique sur <b>“Marquer payé”</b> après ton virement PayPal à la créatrice.</p>

      <div class="kpis">
        <div class="kpi"><label>Ventes (CHF)</label><strong id="kpiSales">—</strong></div>
        <div class="kpi"><label>Pour créatrices (70%)</label><strong id="kpiForCreators">—</strong></div>
        <div class="kpi"><label>Pour Velvet (30%)</label><strong id="kpiForVelvet">—</strong></div>
        <div class="kpi"><label>Impayé total</label><strong id="kpiUnpaid">—</strong></div>
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <table class="table" id="creatorsSummary">
          <thead>
            <tr>
              <th>Créatrice</th>
              <th>Ventes (CHF)</th>
              <th class="hide-sm">Pour elle (70%)</th>
              <th>Pour Velvet (30%)</th>
              <th>Impayé</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="6" class="muted">Chargement…</td></tr></tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="exportCsv" class="btn ghost small">Exporter CSV</button>
        <button id="refreshSales" class="btn ghost small">Rafraîchir</button>
      </div>
    </section>

    <!-- Détail des ventes -->
    <section class="panel">
      <h2>Détail des ventes</h2>
      <div class="table-wrap">
        <table class="table" id="salesTable">
          <thead>
            <tr>
              <th>Date</th><th>Créatrice</th><th>Type</th><th>Montant</th><th class="hide-sm">Txn</th><th class="hide-sm">Email client</th><th>Statut</th><th>Action</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8" class="muted">Chargement…</td></tr></tbody>
        </table>
      </div>
    </section>

    <footer class="muted">© Velvet — Pilotage plateforme</footer>
  </div>

  <!-- Logic -->
  <script>
    // Helpers
    const $ = (id) => document.getElementById(id);
    const api = (path, opts={}) => fetch(path, Object.assign({
      headers:{'Content-Type':'application/json'}
    }, opts));

    // ====== Comptes ======
    let USERS = [];
    async function loadUsers(){
      const status = $('fStatus').value, role = $('fRole').value, q = $('fQuery').value.trim().toLowerCase();
      const r = await api('/api/list-users');
      const data = await r.json();
      USERS = (data && data.users) ? data.users : [];
      $('kpiUsers').textContent = USERS.length;

      const tbody = $('usersTable').querySelector('tbody');
      tbody.innerHTML = '';
      USERS
        .filter(u => !status || u.status===status)
        .filter(u => !role || u.role===role)
        .filter(u => !q || (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))
        .sort((a,b)=> (b.created||'').localeCompare(a.created||''))
        .forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(u.created)}</td>
            <td>@${esc(u.username||'')}</td>
            <td class="hide-sm">${esc(u.email||'')}</td>
            <td><span class="chip">${u.role||'—'}</span></td>
            <td>${statusChip(u.status)}</td>
            <td class="row-actions">
              ${u.status!=='approved'? `<button class="btn small link" data-act="approve" data-id="${u.id}">Valider</button>`:''}
              ${u.status!=='suspended'? `<button class="btn small link" data-act="suspend" data-id="${u.id}">Suspendre</button>`:''}
              <button class="btn small link" data-act="delete" data-id="${u.id}"><span style="color:var(--danger)">Supprimer</span></button>
            </td>`;
          tbody.appendChild(tr);
        });

      // actions comptes
      tbody.querySelectorAll('button').forEach(b=>{
        b.onclick = async ()=>{
          const id=b.dataset.id, act=b.dataset.act;
          if(act==='delete' && !confirm("Supprimer ce profil ? Cette action est définitive.")) return;
          if(act==='suspend'){
            const reason = prompt("Motif de suspension (visible admin) :","Non conforme");
            await api('/api/admin-users',{method:'POST',body:JSON.stringify({action:'suspend',id,reason})});
          }else if(act==='approve'){
            await api('/api/admin-users',{method:'POST',body:JSON.stringify({action:'approve',id})});
          }else if(act==='delete'){
            await api('/api/admin-users',{method:'POST',body:JSON.stringify({action:'delete',id})});
          }
          loadUsers();
        };
      });
    }

    // ====== Ventes & ledger ======
    let LEDGER = [];
    async function loadSales(){
      const r = await api('/api/list-ledger');
      const data = await r.json();
      LEDGER = (data && data.sales) ? data.sales : [];

      // KPIs
      const total   = sum(LEDGER.map(s=> s.amount||0));
      const for70   = +(total * 0.70).toFixed(2);
      const for30   = +(total * 0.30).toFixed(2);
      const unpaid  = sum(LEDGER.filter(s=>!s.paid).map(s=> (s.amount||0)*0.70 ));

      $('kpiSales').textContent = fmtCHF(total);
      $('kpiForCreators').textContent = fmtCHF(for70);
      $('kpiForVelvet').textContent = fmtCHF(for30);
      $('kpiUnpaid').textContent = fmtCHF(unpaid);

      // par créatrice
      const byCreator = {};
      LEDGER.forEach(s=>{
        const id = s.creatorId || 'inconnu';
        if(!byCreator[id]) byCreator[id]={creatorId:id,total:0,unpaid:0};
        byCreator[id].total += (s.amount||0);
        if(!s.paid) byCreator[id].unpaid += ((s.amount||0)*0.70);
      });

      const tbody = $('creatorsSummary').querySelector('tbody');
      tbody.innerHTML='';
      Object.values(byCreator).sort((a,b)=>b.total-a.total).forEach(row=>{
        const t70 = +(row.total*0.70).toFixed(2);
        const t30 = +(row.total*0.30).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(row.creatorId)}</td>
          <td>${fmtCHF(row.total)}</td>
          <td class="hide-sm">${fmtCHF(t70)}</td>
          <td>${fmtCHF(t30)}</td>
          <td><span class="chip ${row.unpaid>0?'warn':'ok'}">${fmtCHF(row.unpaid)}</span></td>
          <td><button class="btn small link" data-creator="${row.creatorId}">Marquer payé</button></td>`;
        tbody.appendChild(tr);
      });

      // bouton "Marquer payé" par créatrice
      tbody.querySelectorAll('button[data-creator]').forEach(b=>{
        b.onclick = async ()=>{
          if(!confirm("Confirmer que les virements à cette créatrice ont été effectués ?")) return;
          await api('/api/mark-paid',{method:'POST',body:JSON.stringify({creatorId:b.dataset.creator})});
          loadSales();
        };
      });

      // détail ventes
      const tb = $('salesTable').querySelector('tbody');
      tb.innerHTML='';
      LEDGER.sort((a,b)=> (b.date||'').localeCompare(a.date||'')).forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${fmtDate(s.date)}</td>
          <td>${esc(s.creatorId||'—')}</td>
          <td>${esc(s.type||'—')}</td>
          <td>${fmtCHF(s.amount||0)}</td>
          <td class="hide-sm">${esc(s.txn||'—')}</td>
          <td class="hide-sm">${esc(s.clientEmail||'—')}</td>
          <td>${s.paid?'<span class="chip ok">payé</span>':'<span class="chip warn">impayé</span>'}</td>
          <td class="row-actions">
            ${!s.paid? `<button class="btn small link" data-one="${s.id||''}">Marquer payé</button>`:''}
          </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-one]').forEach(b=>{
        b.onclick = async ()=>{
          await api('/api/mark-paid',{method:'POST',body:JSON.stringify({saleId:b.dataset.one})});
          loadSales();
        };
      });
    }

    // ====== Export CSV (détail) ======
    $('exportCsv').onclick = ()=>{
      const head = ['date','creatorId','type','amount','txn','clientEmail','paid'];
      const rows = LEDGER.map(s=> [s.date||'',s.creatorId||'',s.type||'',String(s.amount||0),s.txn||'',s.clientEmail||'',s.paid?'yes':'no']);
      const csv = [head, ...rows].map(r=> r.map(x=> `"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `velvet-sales-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };

    // ====== Utils ======
    function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmtCHF(v){ return `${Number(v||0).toFixed(2)} CHF`; }
    function sum(arr){ return +arr.reduce((a,b)=>a+Number(b||0),0).toFixed(2); }
    function fmtDate(iso){ if(!iso) return '—'; try{ return new Date(iso).toLocaleString(); }catch{ return iso; } }
    function statusChip(s){
      if(s==='approved') return '<span class="chip ok">validé</span>';
      if(s==='suspended') return '<span class="chip warn">suspendu</span>';
      if(s==='deleted') return '<span class="chip danger">supprimé</span>';
      return '<span class="chip">en attente</span>';
    }

    // événements
    $('applyUsersFilters').onclick = loadUsers;
    $('refreshAll').onclick = ()=>{ loadUsers(); loadSales(); };
    $('refreshSales').onclick = loadSales;

    // init
    loadUsers(); loadSales();
  </script>
</body>
</html>
