<script>
const CREATOR_ID = window.CREATOR_ID || 'creatrice-demo';

document.getElementById('sendPPV').onclick = async () => {
  const file  = document.getElementById('file').files[0];
  const price = parseFloat(document.getElementById('ppvPrice').value || '0');

  if (!file) return alert('Sélectionnez un fichier');
  if (!(price > 0)) return alert('Le prix doit être supérieur à 0');

  const previewUrl = URL.createObjectURL(file); // provisoire pour test

  const res = await fetch('/api/upsert-item', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      creatorId: CREATOR_ID,
      title: file.name,
      type: file.type.startsWith('video') ? 'video' : 'image',
      previewUrl,
      price
    })
  });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Erreur: ' + (data.error || 'serveur'));

  addLockedMessage({ itemId: data.itemId, previewUrl, price });
  document.getElementById('file').value = '';
  document.getElementById('ppvPrice').value = '';
};

function addLockedMessage({ itemId, previewUrl, price }) {
  const li = document.createElement('li');
  li.className = 'msg locked';
  li.innerHTML = `
    <div class="thumb" style="filter: blur(10px);">
      <img src="${previewUrl}" alt="aperçu verrouillé" style="max-width:220px;border-radius:12px;">
    </div>
    <div class="actions">
      <a class="btn gold" href="paiement.html?item=${encodeURIComponent(itemId)}">
        Débloquer pour ${price.toFixed(2)} CHF
      </a>
    </div>
  `;
  document.getElementById('thread').appendChild(li);
}
</script>
