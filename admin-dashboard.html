<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Velvet (admin)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e6e9f2;
      --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --info:#3498db;
      --line:#252a33; --chip:#202633; --btn:#2a3040; --btnH:#32394d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg,#0e1014,#0b0d11);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(6px);
      background:rgba(15,17,21,.8);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px;}
    .brand{font-weight:800; font-size:20px; letter-spacing:.2px}
    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .nav a{
      padding:8px 12px; border-radius:10px; background:var(--btn);
      border:1px solid var(--line); color:var(--text); text-decoration:none; font-weight:600;
    }
    .nav a:hover{background:var(--btnH)}
    h2{margin:18px 0 10px}
    .hint{color:var(--muted); font-size:13px; margin:4px 0 12px}
    .cards{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:900px){ .cards{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px;
      box-shadow:0 15px 35px rgba(0,0,0,.25);
    }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px}
    select,input[type="search"]{
      background:var(--chip); border:1px solid var(--line); color:var(--text);
      padding:8px 10px; border-radius:10px; outline:none;
    }
    .btn{
      background:var(--btn); border:1px solid var(--line); color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn:hover{background:var(--btnH)}
    .btn.ok{border-color:#214c36; background:#1a3c2c}
    .btn.warn{border-color:#5a4b17; background:#3c3111}
    .btn.bad{border-color:#5e2020; background:#3b1515}
    .btn.small{padding:6px 10px; font-size:13px}
    table{width:100%; border-collapse:collapse; border-spacing:0; font-size:14px}
    thead th{
      text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.4px;
      color:var(--muted); padding:10px 8px; border-bottom:1px solid var(--line); position:sticky; top:0; background:var(--panel);
    }
    tbody td{padding:10px 8px; border-bottom:1px solid var(--line)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--chip); padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px;
    }
    .chip.ok{color:#8ff0b4; border-color:#214c36; background:#16261f}
    .chip.warn{color:#ffe08a; border-color:#5a4b17; background:#2a2410}
    .chip.bad{color:#ff9aa0; border-color:#5e2020; background:#2b1416}
    .muted{color:var(--muted)}
    .sum{margin-top:10px; font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .empty{padding:14px; text-align:center; color:var(--muted)}
    .section-gap{margin-top:14px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">Dashboard — Velvet (admin)</div>
      <div class="nav">
        <a href="/index.html">Accueil</a>
        <a href="/admin-items.html">Créer un item</a>
        <button id="reload" class="btn small">Rafraîchir</button>
        <span id="msg" class="muted"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- COMPTES -->
    <section class="card">
      <h2>Comptes — valider / suspendre / supprimer</h2>
      <p class="hint">“Suspendre” bloque l’accès, sans supprimer les données. Les motifs sont enregistrés.</p>
      <div class="toolbar">
        <label>Statut
          <select id="fltStatus">
            <option value="all">Tous</option>
            <option value="pending">En attente</option>
            <option value="active">Actif</option>
            <option value="suspended">Suspendu</option>
          </select>
        </label>
        <label>Rôle
          <select id="fltRole">
            <option value="all">Tous</option>
            <option value="creator">Créatrice</option>
            <option value="client">Client</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <input id="fltSearch" type="search" placeholder="Recherche (pseudo / email)" />
        <button class="btn" id="refreshUsers">Rafraîchir</button>
      </div>
      <div class="tablebox">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Pseudo</th><th>Email</th><th>Rôle</th><th>Statut</th><th class="right">Action</th>
            </tr>
          </thead>
          <tbody id="tbUsers">
            <tr><td colspan="6" class="empty">Chargement…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VENTES / RÉPARTITION -->
    <section class="card section-gap">
      <h2>Ventes & répartition (70% / 30%)</h2>
      <p class="hint">Clique sur “Marquer payé” quand tu as fait le virement PayPal à la créatrice.</p>
      <div class="toolbar">
        <button class="btn" id="exportCsv">Exporter CSV</button>
        <span id="sumSales" class="sum"></span>
      </div>
      <div class="cards">
        <div class="card">
          <h3 style="margin-top:0">Récap par créatrice</h3>
          <table>
            <thead>
              <tr>
                <th>Créatrice</th><th class="right">Ventes (CHF)</th><th class="right">Pour elle (70%)</th><th class="right">Pour Velvet (30%)</th><th class="right">Impayé</th><th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="tbCreators">
              <tr><td colspan="6" class="empty">Chargement…</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Détail des ventes</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Créatrice</th><th>Type</th><th class="right">Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="tbSales">
              <tr><td colspan="8" class="empty">Chargement…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

<script>
/* ---------- Helpers UI ---------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
const fmt = n => Number(n||0).toFixed(2);
const msg = (t, ok=true) => { const m=$("#msg"); m.textContent=t||""; m.style.color= ok ? "#8ff0b4" : "#ff9aa0"; setTimeout(()=>m.textContent="", 4000); };

/* ---------- API wrappers ---------- */
async function api(path, opt){
  const r = await fetch(path, {headers:{'Content-Type':'application/json'}, ...opt});
  let data = null;
  try{ data = await r.json(); }catch(e){}
  return { ok:r.ok, status:r.status, data };
}
const listUsers   = () => api('/api/list-users');
const suspendUser = (id,reason) => api('/api/suspend-user',{method:'POST', body:JSON.stringify({ id, reason })});
const unsuspendUser = (id) => api('/api/unsuspend-user',{method:'POST', body:JSON.stringify({ id })});
const deleteUser  = (id) => api('/api/delete-user',{method:'POST', body:JSON.stringify({ id })});

const listLedger  = () => api('/api/list-ledger');
const markPaid    = (payload) => api('/api/mark-paid',{method:'POST', body:JSON.stringify(payload)});

/* ---------- State ---------- */
let USERS = [];
let LEDGER = { creators:[], sales:[] };

/* ---------- Rendu Comptes ---------- */
function renderUsers(){
  const tbody = $('#tbUsers');
  if(!USERS.length){ tbody.innerHTML = `<tr><td colspan="6" class="empty">Aucun compte</td></tr>`; return;}
  const st = $('#fltStatus').value, role = $('#fltRole').value, q = $('#fltSearch').value.trim().toLowerCase();

  const rows = USERS.filter(u=>{
    const okS = st==='all' || (u.status||'pending')===st;
    const okR = role==='all' || (u.role||'client')===role;
    const okQ = !q || (String(u.username||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q));
    return okS && okR && okQ;
  }).map(u=>{
    const badge = (u.status==='active') ? 'ok' : (u.status==='suspended' ? 'warn' : 'bad');
    return `<tr>
      <td class="mono">${(u.createdAt||'').slice(0,10)}</td>
      <td>${u.username||'-'}</td>
      <td class="mono">${u.email||'-'}</td>
      <td><span class="chip">${u.role||'client'}</span></td>
      <td><span class="chip ${badge}">${u.status||'pending'}</span></td>
      <td class="right">
        ${u.status!=='active' ? `<button class="btn ok small" data-act="approve" data-id="${u.id}">Valider</button>`:''}
        ${u.status!=='suspended' ? `<button class="btn warn small" data-act="suspend" data-id="${u.id}">Suspendre</button>`:`<button class="btn small" data-act="unsuspend" data-id="${u.id}">Réactiver</button>`}
        <button class="btn bad small" data-act="delete" data-id="${u.id}">Supprimer</button>
      </td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows || `<tr><td colspan="6" class="empty">Aucun résultat</td></tr>`;

  // actions
  tbody.onclick = async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;
    if(act==='approve'){
      // approuver = passer le statut à active
      const res = await unsuspendUser(id); // si tu préfères un /approve-user dédié, change ici
      res.ok ? (await loadUsers(), msg('Compte validé')) : msg('Erreur validation', false);
    }else if(act==='suspend'){
      const reason = prompt('Motif de suspension (interne) :','');
      if(reason===null) return;
      const res = await suspendUser(id,reason);
      res.ok ? (await loadUsers(), msg('Compte suspendu')) : msg('Erreur suspension', false);
    }else if(act==='unsuspend'){
      const res = await unsuspendUser(id);
      res.ok ? (await loadUsers(), msg('Compte réactivé')) : msg('Erreur réactivation', false);
    }else if(act==='delete'){
      if(!confirm('Supprimer ce profil ? Cette action est irréversible.')) return;
      const res = await deleteUser(id);
      res.ok ? (await loadUsers(), msg('Compte supprimé')) : msg('Erreur suppression', false);
    }
  };
}

/* ---------- Rendu Ledger ---------- */
function renderLedger(){
  const tbC = $('#tbCreators'), tbS = $('#tbSales');
  const creators = LEDGER.creators||[];
  const sales = LEDGER.sales||LEDGER || [];

  // Créateurs
  if(!creators.length){
    tbC.innerHTML = `<tr><td colspan="6" class="empty">Aucun agrégat disponible</td></tr>`;
  }else{
    tbC.innerHTML = creators.map(c=>{
      const total = Number(c.total||0);
      const forCreator = total*0.70;
      const forVelvet  = total*0.30;
      const unpaid     = Number(c.unpaid|| (forCreator - Number(c.paid||0)));
      return `<tr>
        <td>${c.creatorId||'-'}</td>
        <td class="right">${fmt(total)}</td>
        <td class="right">${fmt(forCreator)}</td>
        <td class="right">${fmt(forVelvet)}</td>
        <td class="right"><span class="chip ${unpaid>0?'warn':''} mono">${fmt(unpaid)}</span></td>
        <td class="right">
          <button class="btn ok small" data-act="markPaidCreator" data-creator="${c.creatorId}">Marquer payé</button>
        </td>
      </tr>`;
    }).join('');
    tbC.onclick = async (e)=>{
      const b = e.target.closest('button[data-act="markPaidCreator"]');
      if(!b) return;
      const creatorId = b.dataset.creator;
      if(!confirm(`Confirmer “marqué payé” pour ${creatorId} ?`)) return;
      const res = await markPaid({ creatorId });
      res.ok ? (await loadLedger(), msg('Marqué payé (créatrice)')) : msg('Erreur mark-paid', false);
    };
  }

  // Ventes
  if(!sales.length){
    tbS.innerHTML = `<tr><td colspan="8" class="empty">Aucune vente</td></tr>`;
  }else{
    tbS.innerHTML = sales.map(s=>{
      const badge = s.paid ? 'ok' : 'warn';
      return `<tr>
        <td class="mono">${(s.date||'').slice(0,16).replace('T',' ')}</td>
        <td>${s.creatorId||'-'}</td>
        <td><span class="chip">${s.type||'-'}</span></td>
        <td class="right">${fmt(s.amount)}</td>
        <td class="mono">${s.txnId||'-'}</td>
        <td class="mono">${s.buyerEmail||'-'}</td>
        <td><span class="chip ${badge}">${s.paid?'payé':'impayé'}</span></td>
        <td class="right">
          ${s.paid ? '' : `<button class="btn ok small" data-act="markPaidSale" data-id="${s.id}">Marquer payé</button>`}
        </td>
      </tr>`;
    }).join('');
    tbS.onclick = async (e)=>{
      const b = e.target.closest('button[data-act="markPaidSale"]');
      if(!b) return;
      const saleId = b.dataset.id;
      if(!confirm('Confirmer “marqué payé” pour cette vente ?')) return;
      const res = await markPaid({ saleId });
      res.ok ? (await loadLedger(), msg('Vente marquée payée')) : msg('Erreur mark-paid', false);
    };
  }

  // Somme
  const tot = (LEDGER.sales||[]).reduce((a,s)=>a+Number(s.amount||0),0);
  $('#sumSales').innerHTML = `Total ventes affichées : <b>${fmt(tot)} CHF</b>`;
}

/* ---------- Export CSV (détail des ventes affichées) ---------- */
function exportCSV(){
  const rows = [['date','creatorId','type','amount','txnId','buyerEmail','paid']];
  (LEDGER.sales||[]).forEach(s=>{
    rows.push([s.date, s.creatorId, s.type, fmt(s.amount), s.txnId||'', s.buyerEmail||'', s.paid?'1':'0']);
  });
  const csv = rows.map(r=>r.map(v=>{
    const t = String(v??'');
    return /[",;\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t;
  }).join(';')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `velvet_sales_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/* ---------- Loaders ---------- */
async function loadUsers(){
  $('#tbUsers').innerHTML = `<tr><td colspan="6" class="empty">Chargement…</td></tr>`;
  const r = await listUsers();
  if(!r.ok){ $('#tbUsers').innerHTML = `<tr><td colspan="6" class="empty">Erreur chargement utilisateurs</td></tr>`; return; }
  USERS = r.data?.users || r.data || [];
  renderUsers();
}
async function loadLedger(){
  $('#tbCreators').innerHTML = `<tr><td colspan="6" class="empty">Chargement…</td></tr>`;
  $('#tbSales').innerHTML = `<tr><td colspan="8" class="empty">Chargement…</td></tr>`;
  const r = await listLedger();
  if(!r.ok){ $('#tbCreators').innerHTML = `<tr><td colspan="6" class="empty">Erreur ledger</td></tr>`; $('#tbSales').innerHTML = `<tr><td colspan="8" class="empty">Erreur ledger</td></tr>`; return; }
  // Tolère 2 formats : {creators, sales} OU simplement sales[]
  if(Array.isArray(r.data)){
    LEDGER = { creators:[], sales:r.data };
  }else{
    LEDGER = { creators:r.data.creators||[], sales:r.data.sales||[] };
  }
  renderLedger();
}

/* ---------- Events ---------- */
$('#reload').onclick = () => { loadUsers(); loadLedger(); };
$('#refreshUsers').onclick = () => loadUsers();
$('#fltStatus').onchange = renderUsers;
$('#fltRole').onchange = renderUsers;
$('#fltSearch').oninput = ()=>{ clearTimeout(window.__q); window.__q=setTimeout(renderUsers,150); };
$('#exportCsv').onclick = exportCSV;

/* ---------- Init ---------- */
loadUsers(); loadLedger();
</script>
</body>
</html>
