<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Velvet â€” Admin Comptes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/admin.css"/>
</head>
<body>
  <aside class="sidebar">
    <h2>VELVET ADMIN</h2>
    <nav class="nav">
      <a href="/admin-dashboard.html">ðŸ“Š AperÃ§u</a>
      <a class="active" href="/admin-users.html">ðŸ‘¤ Comptes</a>
      <a href="/admin-dashboard.html#sales">ðŸ’³ Ventes</a>
      <a href="/admin-dashboard.html#convs">ðŸ’¬ Conversations</a>
      <a href="/admin-dashboard.html#lives">ðŸŽ¥ Lives</a>
      <a href="/admin-items.html">âž• CrÃ©er un item</a>
    </nav>
    <div class="foot">Â© Velvet Creators VIP</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <input id="q" class="input" placeholder="Rechercher (pseudo, email)"/>
        <select id="f_role" class="input">
          <option value="">RÃ´le : Tous</option>
          <option value="creatrice">CrÃ©atrice</option>
          <option value="client">Client</option>
        </select>
        <select id="f_status" class="input">
          <option value="">Statut : Tous</option>
          <option value="pending">En attente</option>
          <option value="active">Actif</option>
          <option value="suspended">Suspendu</option>
        </select>
        <button class="btn" id="btnSearch">Filtrer</button>
      </div>
      <div class="chips">
        <button class="btn" id="btnPurge">Purger inactifs (90 j)</button>
        <button class="btn" id="btnReload">RafraÃ®chir</button>
      </div>
    </div>

    <section class="section">
      <h2>Comptes (validation / modÃ©ration)</h2>
      <table id="t-users">
        <thead><tr><th>Date</th><th>Pseudo</th><th>Email</th><th>RÃ´le</th><th>Statut</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="6">Chargementâ€¦</td></tr></tbody>
      </table>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);
const api = (p,opt={}) => fetch(p,{headers:{'Content-Type':'application/json'},...opt});

async function loadUsers(){
  const tbody = $('#t-users tbody'); tbody.innerHTML='<tr><td colspan="6">Chargementâ€¦</td></tr>';
  const r = await api('/api/list-users');
  if(!r.ok){ tbody.innerHTML='<tr><td colspan="6">Erreur chargement</td></tr>'; return; }
  const j = await r.json();
  let list = j.users||[];

  const q = ($('#q').value||'').toLowerCase();
  const role = $('#f_role').value; const status = $('#f_status').value;
  if(q) list = list.filter(u => (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
  if(role) list = list.filter(u => (u.role||'')===role);
  if(status) list = list.filter(u => (u.status||'')===status);

  if(!list.length){ tbody.innerHTML='<tr><td colspan="6">Aucun rÃ©sultat</td></tr>'; return; }
  tbody.innerHTML = list.map(u=>{
    const created = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-';
    const sChip = u.status==='active' ? '<span class="chip ok">actif</span>' :
                  u.status==='pending' ? '<span class="chip">en attente</span>' :
                  '<span class="chip bad">suspendu</span>';
    return `<tr>
      <td>${created}</td><td>${u.username||'-'}</td><td>${u.email||'-'}</td>
      <td>${u.role||'-'}</td><td>${sChip}</td>
      <td>
        <button class="btn" data-act="validate" data-id="${u.id}">Valider</button>
        <button class="btn warn" data-act="suspend" data-id="${u.id}">Suspendre</button>
        <button class="btn danger" data-act="delete" data-id="${u.id}">Supprimer</button>
      </td>
    </tr>`;
  }).join('');
}

document.addEventListener('click', async (e)=>{
  const b = e.target.closest('button[data-act]'); if(!b) return;
  const id = b.dataset.id, act=b.dataset.act;
  if(act==='delete' && !confirm('Supprimer ce compte ?')) return;
  let reason = '';
  if(act==='suspend') reason = prompt('Motif de suspension :','ModÃ©ration')||'';
  const r = await api('/api/moderate',{method:'POST', body:JSON.stringify({userId:id, action:act, reason})});
  if(!r.ok){ alert('Erreur modÃ©ration'); return; }
  loadUsers();
});

$('#btnSearch').onclick = loadUsers;
$('#btnReload').onclick = loadUsers;
$('#btnPurge').onclick = async ()=>{
  if(!confirm('Supprimer les comptes inactifs depuis 90 jours ?')) return;
  const r = await api('/api/purge-inactive',{method:'POST'});
  const j = await r.json();
  alert(j.ok?('Comptes supprimÃ©s : '+(j.count||0)):'Erreur purge');
  loadUsers();
};

loadUsers();
</script>
</body>
</html>
