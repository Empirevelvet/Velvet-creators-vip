<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velvet ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#121214;
      --panel-2:#17171a;
      --line:#2a2a2f;
      --ink:#e6e6e9;
      --muted:#9aa0a6;
      --gold:#d4af37;
      --gold-2:#c39a2e;
      --ok:#34d399;
      --danger:#ff6b6b;
      --chip:#232329;
      --shadow: 0 10px 28px rgba(0,0,0,.45);
      --radius:14px;
    }
    *,*:before,*:after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:linear-gradient(180deg,#0a0a0a 0%, #0c0c0e 100%);
      color:var(--ink); font:15px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
    }
    a{ color:var(--gold) ; text-decoration:none }
    a:hover{ opacity:.9 }
    .layout{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh }
    .sidebar{
      background:var(--panel);
      border-right:1px solid var(--line);
      padding:18px 14px; position:sticky; top:0; height:100vh; overflow:auto;
    }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:18px }
    .brand .logo{
      width:30px;height:30px;border-radius:8px;
      background: radial-gradient(120% 120% at 20% 20%, var(--gold) , #7e5e10);
      box-shadow: 0 4px 18px rgba(212,175,55,.3);
    }
    .brand h1{ font-size:15px; margin:0; letter-spacing:.12em; text-transform:uppercase; color:var(--ink) }
    .nav{ display:flex; flex-direction:column; gap:6px; margin-top:8px }
    .nav a{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px;
      color:var(--ink); background:transparent; border:1px solid transparent;
    }
    .nav a.active, .nav a:hover{
      background:var(--panel-2); border-color:var(--line);
    }
    .chip{ background:var(--chip); border:1px solid var(--line); color:var(--muted);
      padding:4px 8px; border-radius:999px; font-size:12px }
    .topbar{
      display:flex; justify-content:space-between; align-items:center; padding:16px 22px;
      border-bottom:1px solid var(--line); background:rgba(0,0,0,.2); position:sticky; top:0; z-index:5;
      backdrop-filter: blur(8px);
    }
    .btn{
      background:linear-gradient(180deg,var(--gold),var(--gold-2));
      border:0; color:#111; font-weight:700; border-radius:10px; padding:10px 14px; cursor:pointer
    }
    .btn.ghost{ background:transparent; color:var(--gold); border:1px solid var(--gold) }
    .btn.small{ padding:6px 10px; font-size:12px }
    .content{ padding:22px; display:grid; gap:18px }
    .cards{ display:grid; grid-template-columns: repeat(4,minmax(220px,1fr)); gap:16px }
    @media (max-width:1100px){ .layout{ grid-template-columns: 84px 1fr } .nav a span{ display:none } .cards{ grid-template-columns: repeat(2,minmax(220px,1fr)); } }
    @media (max-width:700px){ .cards{ grid-template-columns: 1fr } }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--line); border-radius: var(--radius); padding:16px; box-shadow:var(--shadow)
    }
    .card h3{ margin:0 0 8px; font-size:14px; color:var(--muted); font-weight:600 }
    .card .big{ font-size:28px; font-weight:800; letter-spacing:.02em }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .grid-1{ display:grid; grid-template-columns: 1fr; gap:16px }
    .panel{ background:var(--panel); border:1px solid var(--line); border-radius: var(--radius); padding:16px; box-shadow:var(--shadow) }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th, td{ padding:10px 12px; border-bottom:1px solid var(--line) }
    th{ text-align:left; color:var(--muted); font-weight:700; letter-spacing:.02em }
    tr:hover td{ background:rgba(255,255,255,.02) }
    .status{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:var(--chip) }
    .ok{ color:var(--ok) } .bad{ color:var(--danger) }
    .muted{ color:var(--muted) }
    .right{ text-align:right }
    .search{ display:flex; gap:8px }
    input, select{
      background:#0f0f11; border:1px solid var(--line); color:var(--ink); border-radius:10px; padding:10px 12px; outline:none;
    }
    .footer{ color:var(--muted); font-size:12px; padding:10px 0 0 }
    .pulse{ position:relative }
    .pulse:after{ content:''; position:absolute; right:-6px; top:-6px; width:10px; height:10px; border-radius:50%; background:var(--ok);
      box-shadow:0 0 0 0 rgba(52,211,153,.7); animation:pulse 2s infinite }
    @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(52,211,153,.7) } 70%{ box-shadow:0 0 0 12px rgba(52,211,153,0) } 100%{ box-shadow:0 0 0 0 rgba(52,211,153,0) } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div><h1>VELVET admin</h1></div>
      <nav class="nav">
        <a href="#overview" class="active">üè† <span>Aper√ßu</span></a>
        <a href="#accounts">üë§ <span>Comptes</span></a>
        <a href="#sales">üí≥ <span>Ventes</span></a>
        <a href="#conversations">üí¨ <span>Conversations</span></a>
        <a href="#lives">üé• <span>Lives</span></a>
        <a href="admin-items.html" class="ghost">üß∞ <span>Cr√©er un item</span></a>
      </nav>
      <div class="footer">¬© Velvet Creators VIP</div>
    </aside>

    <main>
      <div class="topbar">
        <div class="search">
          <input id="q" placeholder="Rechercher (pseudo, email‚Ä¶)" />
          <button class="btn small" id="btnSearch">Filtrer</button>
          <span class="chip" id="lastRefresh">‚Äî</span>
        </div>
        <div class="actions">
          <button class="btn ghost" id="btnPrune">üßπ Purger inactifs (90 j)</button>
          <button class="btn ghost" id="btnReload">Rafra√Æchir</button>
        </div>
      </div>

      <div class="content" id="overview">
        <section class="cards">
          <div class="card"><h3>Utilisateurs en ligne</h3><div class="big pulse" id="k-online">0</div><div class="muted">dans les 5 derni√®res minutes</div></div>
          <div class="card"><h3>Inscriptions en attente</h3><div class="big" id="k-pending">0</div><div class="muted">√† valider</div></div>
          <div class="card"><h3>Ventes (aujourd‚Äôhui)</h3><div class="big" id="k-today">0.00 CHF</div><div class="muted">tickets & PPV</div></div>
          <div class="card"><h3>Impay√© total</h3><div class="big bad" id="k-unpaid">0.00 CHF</div><div class="muted">√† verser aux cr√©atrices</div></div>
        </section>

        <section class="grid-2">
          <div class="panel">
            <h3>Derni√®res ventes</h3>
            <table id="tbl-latest">
              <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="right">Montant</th><th>Client</th><th>Action</th></tr></thead>
              <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
            </table>
          </div>
          <div class="panel">
            <h3>R√©cap ventes par cr√©atrice</h3>
            <table id="tbl-creators">
              <thead><tr><th>Cr√©atrice</th><th class="right">Ventes (CHF)</th><th class="right">Pour elle (70%)</th><th class="right">Pour Velvet (30%)</th><th class="right">Impay√©</th><th>Action</th></tr></thead>
              <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
            </table>
            <div class="right" style="margin-top:10px">
              <button class="btn small" id="exportCSV">Exporter CSV</button>
            </div>
          </div>
        </section>

        <section id="accounts" class="panel">
          <h3>Comptes ‚Äî valider / suspendre / supprimer</h3>
          <div class="muted" style="margin:6px 0 10px">‚ÄúSuspendre‚Äù bloque l‚Äôacc√®s sans supprimer les donn√©es. Les motifs sont enregistr√©s.</div>
          <div class="search" style="margin-bottom:10px">
            <select id="fStatus">
              <option value="">Statut : Tous</option>
              <option value="pending">pending</option>
              <option value="active">active</option>
              <option value="suspended">suspended</option>
            </select>
            <select id="fRole">
              <option value="">R√¥le : Tous</option>
              <option value="creatrice">creatrice</option>
              <option value="client">client</option>
            </select>
            <input id="fQuery" placeholder="pseudo / email‚Ä¶"/>
            <button class="btn small" id="btnFilter">Filtrer</button>
          </div>

          <table id="tbl-users">
            <thead><tr><th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </section>

        <section id="sales" class="panel">
          <h3>D√©tail des ventes</h3>
          <table id="tbl-sales">
            <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="right">Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="8">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </section>

        <section id="conversations" class="panel">
          <h3>Conversations (aper√ßu)</h3>
          <div id="chatBox" class="muted">Indisponible.</div>
        </section>

        <section id="lives" class="panel">
          <h3>Lives en cours / √† venir</h3>
          <div id="liveBox" class="muted">Indisponible.</div>
        </section>

      </div>
    </main>
  </div>

  <script>
  // ====== CONFIG ENDPOINTS ======
  const ENDPOINTS = {
    listUsers:       '/api/list-users',
    updateUser:      '/api/update-user',
    listLedger:      '/api/list-ledger',
    markPaid:        '/api/mark-paid',
    listConversations:'/api/list-conversations',
    listLives:       '/api/list-lives',
    pruneUsers:      '/api/prune-users'
  };

  const $ = (s,rt=document)=>rt.querySelector(s);
  const $$ = (s,rt=document)=>[...rt.querySelectorAll(s)];
  const CHF = (n)=> (Number(n||0)).toFixed(2)+' CHF';

  function setLastRefresh(){
    const el = $('#lastRefresh');
    if(el) el.textContent = new Date().toLocaleTimeString();
  }

  // ====== LOAD USERS ======
  async function loadUsers(){
    try{
      const qs = new URLSearchParams();
      const st = $('#fStatus').value, role = $('#fRole').value, q = $('#fQuery').value.trim();
      if(st) qs.set('status', st);
      if(role) qs.set('role', role);
      if(q) qs.set('q', q);

      const r = await fetch(ENDPOINTS.listUsers + (qs.toString() ? ('?'+qs.toString()) : ''));
      const j = await r.json();
      const users = j.users || j || [];

      // pending count
      $('#k-pending').textContent = users.filter(u=>u.status==='pending').length;

      const tb = $('#tbl-users tbody'); tb.innerHTML = '';
      if(!users.length){ tb.innerHTML = '<tr><td colspan="6">Aucun compte</td></tr>'; return; }

      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(u.createdAt||u.created||Date.now()).toLocaleDateString()}</td>
          <td>${u.username||u.pseudo||'‚Äî'}</td>
          <td>${u.email||'‚Äî'}</td>
          <td>${u.role||'‚Äî'}</td>
          <td><span class="status ${u.status==='active'?'ok':(u.status==='suspended'?'bad':'')}">${u.status||'-'}</span></td>
          <td>
            <button class="btn small" data-act="approve" data-id="${u.id}">Valider</button>
            <button class="btn small" data-act="suspend" data-id="${u.id}">Suspendre</button>
            <button class="btn small" data-act="delete" data-id="${u.id}">Supprimer</button>
          </td>`;
        tb.appendChild(tr);
      });
    }catch(e){
      $('#tbl-users tbody').innerHTML = '<tr><td colspan="6">Erreur chargement utilisateurs</td></tr>';
    }
  }

  // ====== LOAD LEDGER ======
  async function loadLedger(){
    try{
      const r = await fetch(ENDPOINTS.listLedger);
      const j = await r.json();
      const items = j.items || j.sales || [];
      const latest = [...items].sort((a,b)=> new Date(b.date||0)-new Date(a.date||0)).slice(0,10);

      // KPIs
      const today = new Date(); today.setHours(0,0,0,0);
      const todaySum = items.filter(x=> new Date(x.date||0) >= today )
                            .reduce((s,x)=> s + Number(x.amount||0), 0);
      const unpaidSum = items.filter(x=> !x.paid)
                             .reduce((s,x)=> s + Number(x.amount||0), 0);
      $('#k-today').textContent = CHF( j.today ?? todaySum );
      $('#k-unpaid').textContent = CHF( j.unpaidTotal ?? unpaidSum );

      // Derni√®res ventes
      const tb0 = $('#tbl-latest tbody'); tb0.innerHTML = '';
      latest.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(s.date||Date.now()).toLocaleString()}</td>
          <td>${s.creatorName||s.creator||'‚Äî'}</td>
          <td>${s.type||'ppv'}</td>
          <td class="right">${CHF(s.amount)}</td>
          <td>${s.clientEmail||'‚Äî'}</td>
          <td>${s.paid?'':'<button class="btn small" data-pay="'+(s.id||'')+'">Marquer pay√©</button>'}</td>`;
        tb0.appendChild(tr);
      });
      if(!latest.length){ tb0.innerHTML = '<tr><td colspan="6">Aucune vente</td></tr>'; }

      // D√©tail ventes (sales table)
      const tb = $('#tbl-sales tbody'); tb.innerHTML = '';
      items.slice(0,50).forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(s.date||Date.now()).toLocaleString()}</td>
          <td>${s.creatorName||s.creator||'‚Äî'}</td>
          <td>${s.type||'ppv'}</td>
          <td class="right">${CHF(s.amount)}</td>
          <td><code>${s.txn||'‚Äî'}</code></td>
          <td>${s.clientEmail||'‚Äî'}</td>
          <td><span class="status ${s.paid?'ok':''}">${s.paid?'pay√©':'impay√©'}</span></td>
          <td>${s.paid?'':'<button class="btn small" data-pay="'+(s.id||'')+'">Marquer pay√©</button>'}</td>`;
        tb.appendChild(tr);
      });

      // Par cr√©atrice
      const by = {};
      items.forEach(s=>{
        const id = s.creatorId || s.creator || '‚Äî';
        by[id] ??= { name: s.creatorName || s.creator || id, total:0, unpaid:0 };
        by[id].total += Number(s.amount||0);
        if(!s.paid) by[id].unpaid += Number(s.amount||0);
      });
      const tb2 = $('#tbl-creators tbody'); tb2.innerHTML = '';
      Object.values(by).sort((a,b)=>b.total-a.total).forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name}</td>
          <td class="right">${CHF(c.total)}</td>
          <td class="right">${CHF(c.total*0.7)}</td>
          <td class="right">${CHF(c.total*0.3)}</td>
          <td class="right">${CHF(c.unpaid)}</td>
          <td>${c.unpaid>0?'<button class="btn small" data-pay-creator="'+(c.name||'')+'">Marquer pay√©s</button>':''}</td>`;
        tb2.appendChild(tr);
      });
      if(!Object.keys(by).length){ tb2.innerHTML = '<tr><td colspan="6">Aucune donn√©e</td></tr>'; }

    }catch(e){
      $('#tbl-sales tbody').innerHTML = '<tr><td colspan="8">Erreur chargement ventes</td></tr>';
    }
  }

  // ====== LOAD CHAT & LIVE (placeholders si non branch√©s) ======
  async function loadConversations(){
    const box = $('#chatBox');
    try{
      const r = await fetch(ENDPOINTS.listConversations);
      const j = await r.json();
      box.innerHTML = (j.items||[]).slice(0,20).map(m=>`
        <div style="padding:10px;border-bottom:1px solid var(--line)">
          <b>${m.creator||'‚Äî'}</b> ‚Üí <span>${m.client||'‚Äî'}</span>
          <span class="chip">${new Date(m.date||Date.now()).toLocaleString()}</span><br/>
          <span class="muted">${(m.lastMsg||'').slice(0,160)}</span>
        </div>
      `).join('') || '<p>Aucune conversation.</p>';
    }catch(e){ box.textContent='Indisponible.'; }
  }
  async function loadLive(){
    const box = $('#liveBox');
    try{
      const r = await fetch(ENDPOINTS.listLives);
      const j = await r.json();
      box.innerHTML = (j.items||[]).map(x=>`
        <div style="padding:10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;background:var(--panel)">
          <b>${x.title||'Live priv√©'}</b> ‚Äî <span class="chip">${x.status||'√† venir'}</span><br/>
          <small class="muted">Salle: ${x.room||'-'} ‚Ä¢ D√©but: ${new Date(x.start||Date.now()).toLocaleString()}</small>
        </div>
      `).join('') || '<p>Aucun live.</p>';
    }catch(e){ box.textContent='Indisponible.'; }
  }

  // ====== ACTIONS ======
  document.addEventListener('click', async (e)=>{
    const pay = e.target.closest('button[data-pay]');
    if(pay){
      if(!confirm('Confirmer marquer PAY√â cette vente ?')) return;
      const r = await fetch(ENDPOINTS.markPaid, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ saleId: pay.dataset.pay }) });
      if(r.ok){ await loadLedger(); }
      return;
    }
    const payCreator = e.target.closest('button[data-pay-creator]');
    if(payCreator){
      if(!confirm('Marquer comme pay√©s tous les impay√©s de cette cr√©atrice ?')) return;
      const r = await fetch(ENDPOINTS.markPaid, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ creatorName: payCreator.dataset.payCreator }) });
      if(r.ok){ await loadLedger(); }
      return;
    }
    const actBtn = e.target.closest('button[data-act]');
    if(actBtn){
      const id = actBtn.dataset.id, act = actBtn.dataset.act;
      let body = { id };
      if(act==='approve'){ body.status='active'; }
      if(act==='suspend'){ body.status='suspended'; body.reason = prompt('Motif (optionnel) :',''); }
      if(act==='delete'){ if(!confirm('Supprimer d√©finitivement ce profil ?')) return; body.delete=true; }
      const r = await fetch(ENDPOINTS.updateUser, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(r.ok){ await loadUsers(); }
      return;
    }
  });

  $('#btnFilter').onclick = loadUsers;
  $('#btnSearch').onclick = ()=>{ $('#fQuery').value = $('#q').value; loadUsers(); };
  $('#btnReload').onclick = ()=>{ loadUsers(); loadLedger(); loadConversations(); loadLive(); setLastRefresh(); };

  // Purge 90 j
  $('#btnPrune').onclick = async ()=>{
    const ok = confirm('Confirmer la purge des comptes inactifs (‚â• 90 jours) ?');
    if(!ok) return;
    const r = await fetch(ENDPOINTS.pruneUsers);
    const j = await r.json();
    alert(j.success ? `Purge OK ‚Äî Supprim√©s: ${j.deleted} / V√©rifi√©s: ${j.checked}` : ('√âchec purge: '+(j.error||'inconnu')));
    loadUsers();
  };

  // Auto-refresh toutes les 30 s
  setInterval(()=>{ $('#btnReload').click(); }, 30000);

  // First load
  $('#btnReload').click();
  </script>
</body>
</html>
