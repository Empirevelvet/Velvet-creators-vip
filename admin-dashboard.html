<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Velvet — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/admin.css" />
</head>
<body>
  <aside class="sidebar">
    <h2>VELVET ADMIN</h2>
    <nav class="nav">
      <a class="active" href="/admin-dashboard.html">Aperçu</a>
      <a href="/admin-users.html">Comptes</a>
      <a href="#sales">Ventes</a>
      <a href="#convs">Conversations</a>
      <a href="#lives">Lives</a>
      <a href="/admin-items.html">Créer un item</a>
    </nav>
    <div class="foot">© Velvet Creators VIP</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <input id="q" class="input" type="text" placeholder="Rechercher (pseudo, email)" />
        <button class="btn" id="btnFilter">Filtrer</button>
      </div>
      <div class="chips">
        <span class="chip" id="clock">--:--:--</span>
        <button class="btn" id="btnPurge">Purger inactifs (90 j)</button>
        <button class="btn" id="btnReload">Rafraîchir</button>
      </div>
    </div>

    <div class="grid">
      <div class="card"><h3>Utilisateurs en ligne</h3><div class="value" id="k-online">0</div><small>dans les 5 dernières minutes</small></div>
      <div class="card"><h3>Inscriptions en attente</h3><div class="value" id="k-pending">0</div><small>à valider</small></div>
      <div class="card"><h3>Ventes (aujourd’hui)</h3><div class="value" id="k-today">0.00 CHF</div><small>tickets & PPV</small></div>
      <div class="card"><h3>Impayé total</h3><div class="value bad" id="k-due">0.00 CHF</div><small>à verser aux créatrices</small></div>
    </div>

    <section class="section">
      <h2>Dernières ventes</h2>
      <table id="t-last">
        <thead><tr><th>Date</th><th>Créatrice</th><th>Type</th><th>Montant</th><th>Client</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="6">Chargement…</td></tr></tbody>
      </table>
    </section>

    <section class="section">
      <h2>Récap ventes par créatrice</h2>
      <table id="t-creators">
        <thead><tr><th>Créatrice</th><th>Ventes (CHF)</th><th>Pour elle (70%)</th><th>Pour Velvet (30%)</th><th>Impayé</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="6">Chargement…</td></tr></tbody>
      </table>
      <button class="btn" id="btnCsv" style="margin-top:10px">Exporter CSV</button>
    </section>

    <section class="section" id="sales">
      <h2>Détail des ventes</h2>
      <table id="t-ledger">
        <thead><tr><th>Date</th><th>Créatrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="8">Chargement…</td></tr></tbody>
      </table>
    </section>

    <footer class="small">Besoin d’un filtre/onglet en plus ? Tu me dis et je l’ajoute.</footer>
  </main>

  <!-- SCRIPT FINAL UNIQUEMENT -->
  <script>
  // ===== Helpers =====
  const $  = (s, c=document) => c.querySelector(s);
  const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
  const api = (p,opt={}) => fetch(p,{headers:{'Content-Type':'application/json'}, ...opt});
  const fmt = n => Number(n||0).toFixed(2);

  // ===== Tabs (sidebar -> sections) =====
  function activateFromHash() {
    const hash = location.hash || '#overview';
    $$('.nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href')===hash));
    $$('[data-tab]').forEach(sec => { if(sec.id) sec.hidden = ('#'+sec.id !== hash); });
    const el = document.querySelector(hash);
    if (el) el.scrollIntoView({block:'start', behavior:'auto'});
  }
  window.addEventListener('hashchange', activateFromHash);
  document.addEventListener('DOMContentLoaded', activateFromHash);

  // ===== Rendus =====
  function renderLastSales(rows=[]) { /* idem code envoyé avant */ }
  function renderCreatorsRecap(map={}) { /* idem code envoyé avant */ }
  function renderLedger(rows=[]) { /* idem code envoyé avant */ }

  // ===== Chargement global =====
  async function loadDashboard() { /* idem code envoyé avant */ }

  // ===== Actions =====
  async function markPaid(id) { /* idem code envoyé avant */ }
  async function markAllForCreator(name) { /* idem code envoyé avant */ }
  async function purgeInactive90d() { /* idem code envoyé avant */ }
  function exportCsv(){ window.location.href = '/api/list-ledger?format=csv'; }

  // ===== Événements =====
  document.addEventListener('click', (e)=>{
    const bPay  = e.target.closest('button[data-pay]');
    const bBulk = e.target.closest('button[data-bulk]');
    if (bPay)  markPaid(bPay.dataset.pay);
    if (bBulk) markAllForCreator(bBulk.dataset.bulk);
  });
  $('#btnReload')?.addEventListener('click', loadDashboard);
  $('#btnPurge')?.addEventListener('click', purgeInactive90d);
  $('#btnCsv')?.addEventListener('click', exportCsv);
  $('#btnFilter')?.addEventListener('click', ()=>{
    const q = ($('#q')?.value||'').trim();
    location.href = '/admin-users.html' + (q ? ('?q='+encodeURIComponent(q)) : '');
  });

  // Horloge + refresh
  const clockEl = $('#clock');
  if (clockEl) setInterval(()=>{ clockEl.textContent = new Date().toLocaleTimeString(); }, 1000);
  setInterval(loadDashboard, 30_000);

  // Premier chargement
  loadDashboard();
  </script>
</body>
</html>
