<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Velvet ‚Äî Admin Dashboard</title>

<!-- ====== THEME (noir & or) ====== -->
<style>
:root{
  --bg:#0b0b0c; --panel:#121214; --line:#2a2a2f; --ink:#e6e0e9;
  --gold:#d4af37; --muted:#a6a6ad; --radius:14px;
  --shadow: 10px 28px 28px rgba(0,0,0,.55);
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 var(--font);
}
.header{position:sticky;top:0;z-index:10;background:#0f0f11;border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1,h2,h3{margin:0 0 12px}
a{color:var(--gold);text-decoration:none}
a.btn,button.btn{
  display:inline-flex;align-items:center;gap:8px;
  background:linear-gradient(135deg,#2b2720,#12100b);
  color:var(--gold);border:1px solid #3b3325;border-radius:10px;
  padding:9px 14px;box-shadow:var(--shadow);cursor:pointer;
}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.grid{grid-template-columns:1fr}}
.card{
  background:radial-gradient(120% 120% at 90% 10%,rgba(212,175,55,.10) 0%,rgba(18,18,20,1) 55%);
  border:1px solid #2c2b26;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);
}
.card h3{font-weight:700;color:var(--gold);letter-spacing:.3px;margin-bottom:8px}
.kpi{font-size:26px;font-weight:800;color:#f4e6b3}
.table{
  width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px
}
.table th,.table td{padding:10px 12px}
.table thead th{font-size:12px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--line)}
.table tbody tr{background:linear-gradient(180deg,#141416,#121214)}
.table tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
.table tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
.input,.select{
  width:100%;background:#101012;border:1px solid var(--line);color:var(--ink);
  border-radius:10px;padding:10px 12px;outline:none
}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #3b3325;color:#f1e3a6;background:linear-gradient(135deg,#2b2720,#12100b)}
.panel{background:#101012;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
hr{border:0;height:1px;background:var(--line);margin:16px 0}
footer{padding:16px;color:var(--muted);text-align:center}
</style>
:root{
  --bg:#0b0b0c;
  --panel:#121214;
  --panel-2:#17171a;
  --line:#2a2a2f;
  --ink:#e6e6e9;
  --mute:#a6a6ad;
  --gold:#d4af37;
  --gold-2:#c39a2e;
  --danger:#ff4d4d;
  --ok:#40c463;
  --cta:#1f6feb;
  --chip:#232329;
  --radius:14px;
  --shadow:0 10px 28px rgba(0,0,0,.55);
  --shadow-soft:0 6px 20px rgba(0,0,0,.35);
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 var(--font);
}

/* Layout */
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
@media (max-width:980px){ .app{grid-template-columns:1fr} .sidebar{position:sticky;top:0;z-index:20} }

.sidebar{
  background:linear-gradient(180deg,#0e0e10, #121216 60%, #0e0e10);
  border-right:1px solid var(--line);
  padding:18px 14px; box-shadow:var(--shadow-soft);
}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.brand .logo{width:28px;height:28px;border-radius:8px;background:radial-gradient(circle at 40% 35%,var(--gold),#7b5b14);box-shadow:0 0 0 2px #1a1a1a, inset 0 0 12px rgba(0,0,0,.4)}
.brand h1{font-size:17px;letter-spacing:.4px;margin:0}
.brand small{color:var(--mute)}
.nav{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.nav a{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--ink);
  background:transparent;border:1px solid transparent;
}
.nav a .ico{width:22px;text-align:center;opacity:.9}
.nav a.active, .nav a:hover{background:var(--chip);border-color:var(--line)}
.sep{margin:12px 6px;border-bottom:1px dashed var(--line)}

.main{background:var(--bg)}
.header{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;gap:16px;
  padding:14px 18px;border-bottom:1px solid var(--line);background:#0b0b0ce6;backdrop-filter:saturate(120%) blur(8px)
}
.header .path{color:var(--mute);font-size:13px}
.header .path b{color:var(--ink)}
.header .actions{display:flex;gap:10px;align-items:center}
.btn{
  padding:9px 12px;border:1px solid var(--line);border-radius:10px;background:var(--panel);
  color:var(--ink);text-decoration:none;cursor:pointer;box-shadow:var(--shadow-soft)
}
.btn:hover{filter:brightness(1.05)}
.btn.gold{background:linear-gradient(180deg,var(--gold),var(--gold-2));color:#161616;border-color:#6f5a19}
.btn.ghost{background:transparent}
.btn.danger{background:#2a1416;border-color:#5a2a2e;color:#ffb0b6}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1b1b1f;border:1px solid var(--line);font-size:12px;color:var(--mute)}

.wrap{padding:18px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
@media (max-width:1100px){ .grid{grid-template-columns:repeat(6,1fr)} }
@media (max-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }

.card{
  grid-column:span 3; background:var(--panel); border:1px solid var(--line); border-radius:16px;
  padding:16px; box-shadow:var(--shadow)
}
.card.wide{grid-column:span 12}
.card.h6{grid-column:span 6}
.kpi{display:flex;align-items:center;justify-content:space-between}
.kpi .k{font:600 13px var(--font);color:var(--mute)}
.kpi .v{font-size:22px}
.kpi .v.gold{color:var(--gold)}

.table{
  width:100%;border-collapse:separate;border-spacing:0;background:var(--panel-2);
  border:1px solid var(--line);border-radius:14px;overflow:hidden
}
.table th, .table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left}
.table th{background:#111116;color:#bdbdc4;font-weight:600}
.table tr:hover td{background:#141418}
.table .actions{display:flex;gap:6px}
.filterbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.input, select{
  background:#111114;border:1px solid var(--line);border-radius:10px;color:var(--ink);
  padding:9px 10px;outline:none;min-width:120px
}
.input::placeholder{color:#8e8e96}
.status{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.status.ok{background:#0e2616;color:#79e0a1;border-color:#12472a}
.status.pending{background:#262011;color:#f0d08a;border-color:#5a4a19}
.status.sus{background:#261b1b;color:#f3a1a8;border-color:#5a2a2e}

/* Footer */
.footer{padding:18px;color:var(--mute);text-align:center;border-top:1px solid var(--line);margin-top:8px}
</style>
</head>

<body>
<div class="app">
  <!-- ====== SIDEBAR ====== -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>VELVET <small>admin</small></h1>
        <small>Creators VIP</small>
      </div>
    </div>

    <nav class="nav">
      <a href="#" class="active" data-tab="overview"><span class="ico">üè†</span> Aper√ßu</a>
      <a href="#" data-tab="accounts"><span class="ico">üë•</span> Comptes</a>
      <a href="#" data-tab="sales"><span class="ico">üí≥</span> Ventes</a>
      <a href="#" data-tab="chat"><span class="ico">üí¨</span> Conversations</a>
      <a href="#" data-tab="live"><span class="ico">üì°</span> Lives</a>
      <div class="sep"></div>
      <a href="admin-items.html"><span class="ico">üß∞</span> Cr√©er un item</a>
      <a href="index.html"><span class="ico">üè∑Ô∏è</span> Accueil site</a>
    </nav>
  </aside>

  <!-- ====== MAIN ====== -->
  <section class="main">
    <header class="header">
      <div class="path">Velvet ‚Ä¢ <b>Dashboard</b> <span class="badge" id="lastStatus">‚Ä¶</span></div>
      <div class="actions">
        <button class="btn gold" id="reloadAll">Rafra√Æchir</button>
        <a class="btn ghost" href="login.html">D√©connexion</a>
      </div>
    </header>

    <div class="wrap">
      <!-- ====== APER√áU ====== -->
      <div class="grid" id="tab-overview">
        <div class="card">
          <div class="kpi"><div class="k">Utilisateurs en ligne</div><div class="v" id="k-online">0</div></div>
          <small class="mute">Sur les 5 derni√®res minutes</small>
        </div>
        <div class="card">
          <div class="kpi"><div class="k">Inscriptions en attente</div><div class="v" id="k-pending">0</div></div>
          <small class="mute">√† valider</small>
        </div>
        <div class="card">
          <div class="kpi"><div class="k">Ventes (aujourd‚Äôhui)</div><div class="v gold" id="k-today">0.00 CHF</div></div>
          <small class="mute">tickets & PPV</small>
        </div>
        <div class="card">
          <div class="kpi"><div class="k">Impay√© total</div><div class="v" id="k-unpaid">0.00 CHF</div></div>
          <small class="mute">√† verser aux cr√©atrices</small>
        </div>

        <div class="card wide">
          <h3 style="margin:0 0 10px">Derni√®res ventes</h3>
          <table class="table" id="tbl-lastSales">
            <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Client</th><th>Statut</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="8">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ====== COMPTES ====== -->
      <div class="grid" id="tab-accounts" style="display:none">
        <div class="card h6">
          <h3 style="margin:0 0 8px">Filtrer</h3>
          <div class="filterbar">
            <select id="f-status">
              <option value="">Statut : Tous</option>
              <option value="pending">En attente</option>
              <option value="active">Actifs</option>
              <option value="suspended">Suspendus</option>
            </select>
            <select id="f-role">
              <option value="">R√¥le : Tous</option>
              <option value="creatrice">Cr√©atrices</option>
              <option value="client">Clients</option>
            </select>
            <input class="input" id="f-q" placeholder="pseudo / email‚Ä¶"/>
            <button class="btn" id="btnFilter">Filtrer</button>
          </div>

          <table class="table" id="tbl-users">
            <thead><tr><th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>

        <div class="card h6">
          <h3 style="margin:0 0 8px">R√©cap ventes par cr√©atrice</h3>
          <table class="table" id="tbl-creators">
            <thead><tr><th>Cr√©atrice</th><th>Ventes (CHF)</th><th>Pour elle (70%)</th><th>Pour Velvet (30%)</th><th>Impay√©</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ====== VENTES ====== -->
      <div class="grid" id="tab-sales" style="display:none">
        <div class="card wide">
          <h3 style="margin:0 0 8px">D√©tail des ventes</h3>
          <table class="table" id="tbl-sales">
            <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="8">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ====== CONVERSATIONS (placeholder) ====== -->
      <div class="grid" id="tab-chat" style="display:none">
        <div class="card wide">
          <h3 style="margin:0 0 8px">Conversations (aper√ßu)</h3>
          <p class="badge">Bient√¥t : fil des derniers messages + mod√©ration</p>
          <div id="chatBox" style="margin-top:10px">Chargement‚Ä¶</div>
        </div>
      </div>

      <!-- ====== LIVES (placeholder) ====== -->
      <div class="grid" id="tab-live" style="display:none">
        <div class="card wide">
          <h3 style="margin:0 0 8px">Lives en cours / √† venir</h3>
          <div id="liveBox">Chargement‚Ä¶</div>
        </div>
      </div>

      <div class="footer">¬© Velvet Creators VIP</div>
    </div>
  </section>
</div>

<!-- ====== JS (connexion aux endpoints existants) ====== -->
<script>
// util
const $ = (s,rt=document)=>rt.querySelector(s);
const $$ = (s,rt=document)=>[...rt.querySelectorAll(s)];
const api = (p, opt={}) => fetch(p, { headers:{'Content-Type':'application/json'}, ...opt });
const money = n => (Number(n||0)).toFixed(2)+' CHF';
const setStatus = (t)=> $("#lastStatus").textContent = t;

// Tabs
$$('.nav a[data-tab]').forEach(a=>{
  a.onclick=e=>{
    e.preventDefault();
    $$('.nav a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const tab = a.dataset.tab;
    ['overview','accounts','sales','chat','live'].forEach(id=>{
      $('#tab-'+id).style.display = (id===tab)?'grid':'none';
    });
  };
});

// ===== Donn√©es =====
async function loadUsers() {
  try{
    const qs = new URLSearchParams();
    const st = $('#f-status').value, role = $('#f-role').value, q = $('#f-q').value.trim();
    if(st) qs.set('status', st);
    if(role) qs.set('role', role);
    if(q) qs.set('q', q);
    const r = await api('/api/list-users?'+qs.toString());
    const data = await r.json();
    const tb = $('#tbl-users tbody');
    tb.innerHTML = '';
    (data.users||[]).forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(u.createdAt||u.created||Date.now()).toLocaleDateString()}</td>
        <td>${u.username||u.pseudo||'‚Äî'}</td>
        <td>${u.email||'‚Äî'}</td>
        <td>${u.role||'‚Äî'}</td>
        <td><span class="status ${u.status==='active'?'ok':u.status==='suspended'?'sus':'pending'}">${u.status}</span></td>
        <td class="actions">
          <button class="btn" data-act="approve" data-id="${u.id}">Valider</button>
          <button class="btn" data-act="suspend" data-id="${u.id}">Suspendre</button>
          <button class="btn danger" data-act="delete" data-id="${u.id}">Supprimer</button>
        </td>`;
      tb.appendChild(tr);
    });
    $('#k-pending').textContent = (data.users||[]).filter(x=>x.status==='pending').length;
  }catch(e){
    $('#tbl-users tbody').innerHTML = `<tr><td colspan="6">Erreur chargement utilisateurs</td></tr>`;
  }
}
async function moderateUser(action,id){
  const reason = (action==='suspend') ? prompt('Motif de suspension ?','Mod√©ration') : undefined;
  const body = { action, userId:id, reason };
  const r = await api('/api/moderate',{method:'POST',body:JSON.stringify(body)});
  if(r.ok){ setStatus('Comptes: '+action+' ‚úî'); loadUsers(); } else alert('Erreur mod√©ration');
}
document.addEventListener('click',(e)=>{
  const b = e.target.closest('button[data-act]');
  if(!b) return;
  moderateUser(b.dataset.act, b.dataset.id);
});

async function loadLedger() {
  try{
    const r = await api('/api/list-ledger');
    const j = await r.json();

    // KPIs
    $('#k-today').textContent = money(j.today||0);
    $('#k-unpaid').textContent = money(j.unpaidTotal||0);

    // Derni√®res ventes
    const tb0 = $('#tbl-lastSales tbody');
    tb0.innerHTML='';
    (j.last||[]).forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(s.date||Date.now()).toLocaleString()}</td>
        <td>${s.creator||'‚Äî'}</td>
        <td>${s.type||'ppv'}</td>
        <td>${money(s.amount)}</td>
        <td><code style="font-family:var(--mono)">${s.txn||'‚Äî'}</code></td>
        <td>${s.clientEmail||'‚Äî'}</td>
        <td><span class="status ${s.paid?'ok':'pending'}">${s.paid?'pay√©':'impay√©'}</span></td>
        <td class="actions">
          ${s.paid?'':`<button class="btn gold" data-pay="${s.id}">Marquer pay√©</button>`}
        </td>`;
      tb0.appendChild(tr);
    });

    // D√©tail ventes
    const tb = $('#tbl-sales tbody');
    tb.innerHTML='';
    (j.sales||[]).forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(s.date||Date.now()).toLocaleString()}</td>
        <td>${s.creator||'‚Äî'}</td>
        <td>${s.type||'ppv'}</td>
        <td>${money(s.amount)}</td>
        <td><code style="font-family:var(--mono)">${s.txn||'‚Äî'}</code></td>
        <td>${s.clientEmail||'‚Äî'}</td>
        <td><span class="status ${s.paid?'ok':'pending'}">${s.paid?'pay√©':'impay√©'}</span></td>
        <td class="actions">
          ${s.paid?'':`<button class="btn gold" data-pay="${s.id}">Marquer pay√©</button>`}
        </td>`;
      tb.appendChild(tr);
    });

    // Par cr√©atrice
    const tb2 = $('#tbl-creators tbody');
    tb2.innerHTML='';
    (j.creators||[]).forEach(c=>{
      const tr = document.createElement('tr');
      const p70 = (c.total||0)*0.70, p30=(c.total||0)*0.30;
      tr.innerHTML = `
        <td>${c.creator}</td>
        <td>${money(c.total)}</td>
        <td>${money(p70)}</td>
        <td>${money(p30)}</td>
        <td>${money(c.unpaid||0)}</td>
        <td class="actions">${(c.unpaid>0)?`<button class="btn gold" data-pay-creator="${c.creatorId}">Marquer pay√©</button>`:''}</td>`;
      tb2.appendChild(tr);
    });

  }catch(e){
    $('#tbl-sales tbody').innerHTML = `<tr><td colspan="8">Erreur chargement ventes</td></tr>`;
  }
}

document.addEventListener('click', async (e)=>{
  // marquer pay√© (vente)
  const b = e.target.closest('button[data-pay]');
  if(b){
    if(!confirm('Confirmer le marquage ‚Äúpay√©‚Äù pour cette vente ?')) return;
    const r = await api('/api/mark-paid',{method:'POST',body:JSON.stringify({ saleId:b.dataset.pay })});
    if(r.ok){ setStatus('Vente marqu√©e pay√©e ‚úî'); loadLedger(); } else alert('Erreur');
  }
  // marquer pay√© (cr√©atrice ‚Äì tout impay√©)
  const c = e.target.closest('button[data-pay-creator]');
  if(c){
    if(!confirm('Marquer comme pay√© tous les impay√©s de cette cr√©atrice ?')) return;
    const r = await api('/api/mark-paid',{method:'POST',body:JSON.stringify({ creatorId:c.dataset.payCreator })});
    if(r.ok){ setStatus('Cr√©atrice pay√©e ‚úî'); loadLedger(); } else alert('Erreur');
  }
});

// placeholders ‚Äúlive‚Äù
async function loadConversations(){
  const box = $('#chatBox');
  try{
    const r = await api('/api/list-conversations');
    const j = await r.json();
    box.innerHTML = (j.items||[]).slice(0,20).map(m=>`
      <div style="padding:10px;border-bottom:1px solid var(--line)">
        <b>${m.creator||'‚Äî'}</b> ‚Üí <span>${m.client||'‚Äî'}</span>
        <span class="badge">${new Date(m.date||Date.now()).toLocaleString()}</span><br/>
        <span style="color:var(--mute)">${(m.lastMsg||'').slice(0,160)}</span>
      </div>
    `).join('') || '<p>Aucune conversation.</p>';
  }catch(e){ box.textContent='Indisponible.'; }
}
async function loadLive(){
  const box = $('#liveBox');
  try{
    const r = await api('/api/list-lives');
    const j = await r.json();
    box.innerHTML = (j.items||[]).map(x=>`
      <div style="padding:10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;background:var(--panel)">
        <b>${x.title||'Live priv√©'}</b> ‚Äî <span class="badge">${x.status||'√† venir'}</span><br/>
        <small class="mute">Salle: ${x.room||'-'} ‚Ä¢ D√©but: ${new Date(x.start||Date.now()).toLocaleString()}</small>
      </div>
    `).join('') || '<p>Aucun live.</p>';
  }catch(e){ box.textContent='Indisponible.'; }
}

// √©v√®nements
$('#btnFilter').onclick = loadUsers;
$('#reloadAll').onclick = ()=>{ loadUsers(); loadLedger(); loadConversations(); loadLive(); setStatus('Rafra√Æchi '+new Date().toLocaleTimeString()); };

// init
loadUsers(); loadLedger(); loadConversations(); loadLive();
setStatus('Charg√© '+new Date().toLocaleTimeString());
</script>
</body>
</html>
