<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Velvet ‚Äî Dashboard admin</title>

  <!-- STYLE autonome sombre (aucune d√©pendance externe) -->
  <style>
    :root{
      --bg:#0f1115; --panel:#161a24; --muted:#9aa4b2; --text:#e9edf4;
      --brand:#7c5cff; --ok:#25c08a; --warn:#ffb020; --danger:#ff5a7a;
      --line:#23293a; --chip:#1b2130; --thead:#121827;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(10,12,18,.75),rgba(10,12,18,0));backdrop-filter:blur(8px);z-index:5}
    .top{display:flex;gap:10px;align-items:center}
    .logo{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
    .top .sp{flex:1}
    .btn{background:var(--brand);border:0;color:#fff;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:var(--chip);color:var(--text);border:1px solid var(--line)}
    .btn.small{padding:7px 10px;font-size:12px;border-radius:8px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
    h1{font-size:20px;margin:0 0 8px}
    h2{font-size:16px;margin:0 0 8px}
    .help{font-size:12px;color:var(--muted);margin:4px 0 10px}

    .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr)) auto;gap:8px;margin:8px 0 10px}
    .input, select{width:100%;background:#0f141e;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:9px 10px}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .l{color:var(--muted);font-size:12px}
    .kpi .v{font-size:20px;font-weight:800;margin-top:6px}

    .tablewrap{border:1px solid var(--line);border-radius:12px;overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:780px}
    thead th{position:sticky;top:0;background:var(--thead);color:#b7c0d8;text-align:left;padding:10px 12px;border-bottom:1px solid var(--line);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#151c2a}
    .right{text-align:right}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:var(--chip)}
    .chip.ok{background:rgba(37,192,138,.12);border-color:rgba(37,192,138,.35);color:#9af0cf}
    .chip.warn{background:rgba(255,176,32,.12);border-color:rgba(255,176,32,.35);color:#ffd993}
    .chip.bad{background:rgba(255,90,122,.12);border-color:rgba(255,90,122,.35);color:#ffb5c3}
    .toast{position:fixed;right:14px;bottom:14px;background:#0f1726;border:1px solid var(--line);padding:12px 14px;border-radius:12px;display:none;box-shadow:0 10px 26px rgba(0,0,0,.35);font-weight:700}
    footer{color:var(--muted);text-align:center;padding:22px 0}
    @media(max-width:860px){
      .filters{grid-template-columns:1fr 1fr}
      .kpis{grid-template-columns:1fr 1fr}
      table, thead, tbody, th, td, tr{display:block;width:100%}
      thead{display:none}
      tbody td{border:none;padding:6px 0}
      .tablewrap{border-radius:10px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap top">
      <div class="logo">Velvet ‚Äî <span class="muted">Dashboard (admin)</span></div>
      <span class="sp"></span>
      <a class="btn ghost small" href="/index.html">Accueil</a>
      <a class="btn ghost small" href="/admin-items.html">Cr√©er un item</a>
      <button id="reloadAll" class="btn small">Rafra√Æchir</button>
    </div>
  </header>

  <main class="wrap">
    <!-- COMPTES -->
    <section class="panel">
      <h1>Comptes ‚Äî valider / suspendre / supprimer</h1>
      <div class="help">‚ÄúSuspendre‚Äù bloque l‚Äôacc√®s sans supprimer les donn√©es. Tu peux r√©activer ensuite.</div>

      <div class="filters">
        <select id="fStatus">
          <option value="">Statut : Tous</option>
          <option value="pending">En attente</option>
          <option value="approved">Valid√©</option>
          <option value="suspended">Suspendu</option>
        </select>
        <select id="fRole">
          <option value="">R√¥le : Tous</option>
          <option value="creator">Cr√©atrice</option>
          <option value="client">Client</option>
          <option value="admin">Admin</option>
        </select>
        <input id="fQuery" class="input" placeholder="üîé pseudo / email"/>
        <div class="kpi"><div class="l">Comptes</div><div class="v" id="kUsers">‚Äî</div></div>
        <button id="applyUsersFilters" class="btn small">Filtrer</button>
      </div>

      <div class="tablewrap">
        <table>
          <thead><tr><th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th class="right">Action</th></tr></thead>
          <tbody id="tbUsers"><tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- VENTES -->
    <section class="panel">
      <h1>Ventes & r√©partition (70% / 30%)</h1>
      <div class="help">Clique sur <b>‚ÄúMarquer pay√©‚Äù</b> apr√®s ton virement PayPal √† la cr√©atrice.</div>

      <div class="kpis" style="margin-bottom:10px">
        <div class="kpi"><div class="l">Ventes (CHF)</div><div class="v" id="kTot">‚Äî</div></div>
        <div class="kpi"><div class="l">Pour cr√©atrices (70%)</div><div class="v" id="k70">‚Äî</div></div>
        <div class="kpi"><div class="l">Pour Velvet (30%)</div><div class="v" id="k30">‚Äî</div></div>
        <div class="kpi"><div class="l">Impay√© total</div><div class="v" id="kUnpaid">‚Äî</div></div>
      </div>

      <div class="tablewrap">
        <table>
          <thead><tr><th>Cr√©atrice</th><th class="right">Ventes</th><th class="right">70%</th><th class="right">30%</th><th class="right">Impay√©</th><th class="right">Action</th></tr></thead>
          <tbody id="tbCreators"><tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="exportCsv" class="btn ghost small">Exporter CSV</button>
        <button id="refreshLedger" class="btn ghost small">Rafra√Æchir</button>
      </div>
    </section>

    <!-- D√âTAIL DES VENTES -->
    <section class="panel">
      <h2>D√©tail des ventes</h2>
      <div class="tablewrap">
        <table>
          <thead><tr><th>Date</th><th>Cr√©atrice</th><th>Type</th><th class="right">Montant</th><th>Txn</th><th>Email client</th><th>Statut</th></tr></thead>
        <tbody id="tbSales"><tr><td colspan="7" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- LOGIQUE (autonome) -->
  <script>
    // Helpers
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];
    const fmt = n => Number(n||0).toFixed(2).replace('.',',')+' CHF';
    const toast=(t,ok=true)=>{const el=$("#toast");el.textContent=t;el.style.display="block";el.style.borderColor=ok?"#214c36":"#5e2020";setTimeout(()=>el.style.display="none",2200);};
    const J = async (url,opt)=>{try{const r=await fetch(url,{headers:{'Content-Type':'application/json'},...opt});const d=await r.json().catch(()=>null);return {ok:r.ok, status:r.status, data:d};}catch(e){return {ok:false,status:0,data:null};}};

    // -------- USERS --------
    let USERS=[];
    function badge(s){ if(s==='approved')return '<span class="chip ok">valid√©</span>'; if(s==='suspended')return '<span class="chip warn">suspendu</span>'; return '<span class="chip">en attente</span>'; }

    async function loadUsers(){
      $("#tbUsers").innerHTML='<tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>';
      const r = await J('/api/list-users');
      if(!r.ok){ $("#tbUsers").innerHTML=`<tr><td colspan="6" class="muted">Impossible de charger /api/list-users (status ${r.status}).</td></tr>`; return; }
      USERS = r.data?.users || r.data || [];
      renderUsers();
    }
    function renderUsers(){
      const st=$("#fStatus").value, ro=$("#fRole").value, q=($("#fQuery").value||'').toLowerCase();
      const rows = USERS.filter(u=>(!st||u.status===st)&&(!ro||u.role===ro)&&(!q||String(u.username||'').toLowerCase().includes(q)||String(u.email||'').toLowerCase().includes(q)))
        .sort((a,b)=>String(b.created||'').localeCompare(String(a.created||'')))
        .map(u=>{
          const d = u.created ? new Date(u.created).toLocaleString() : '‚Äî';
          return `<tr>
            <td>${d}</td><td>@${esc(u.username||'')}</td><td>${esc(u.email||'')}</td>
            <td><span class="chip">${u.role||'client'}</span></td><td>${badge(u.status)}</td>
            <td class="right row-actions">
              ${u.status!=='approved'? `<button class="btn small ghost" data-a="approve" data-id="${u.id}">Valider</button>`:''}
              ${u.status!=='suspended'? `<button class="btn small ghost" data-a="suspend" data-id="${u.id}">Suspendre</button>`:''}
              <button class="btn small ghost" data-a="delete" data-id="${u.id}" style="border-color:#5f1e2a;color:#ff94a8">Supprimer</button>
            </td>
          </tr>`;
        }).join('');
      $("#tbUsers").innerHTML = rows || `<tr><td colspan="6" class="muted">Aucun compte.</td></tr>`;
    }
    $("#tbUsers").addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-a]'); if(!b) return;
      const id=b.dataset.id, a=b.dataset.a;
      if(a==='delete' && !confirm('Supprimer d√©finitivement ce profil ?')) return;
      let body={id};
      if(a==='suspend'){ const reason=prompt('Motif (interne) :','Non conforme'); if(reason===null) return; body.reason=reason; }
      const r = await J('/api/admin-users',{method:'POST',body:JSON.stringify({action:a,...body})});
      r.ok ? (toast('OK'), loadUsers()) : toast('Erreur action admin-users', false);
    });
    $("#applyUsersFilters").onclick=renderUsers;

    // -------- LEDGER --------
    let SALES=[];
    async function loadLedger(){
      $("#tbCreators").innerHTML='<tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>';
      $("#tbSales").innerHTML='<tr><td colspan="7" class="muted">Chargement‚Ä¶</td></tr>';
      const r = await J('/api/list-ledger');
      if(!r.ok){ $("#tbCreators").innerHTML=`<tr><td colspan="6" class="muted">Impossible de charger /api/list-ledger (status ${r.status}).</td></tr>`;
                 $("#tbSales").innerHTML=`<tr><td colspan="7" class="muted">Impossible de charger /api/list-ledger (status ${r.status}).</td></tr>`; return; }
      SALES = r.data?.sales || r.data || [];
      renderLedger();
    }
    function renderLedger(){
      const total = SALES.reduce((a,s)=>a+Number(s.amount||0),0);
      const to70  = total*0.70, to30 = total*0.30;
      const unpaid = SALES.filter(s=>!s.paid).reduce((a,s)=>a+Number(s.amount||0)*0.70,0);
      $("#kTot").textContent=fmt(total);
      $("#k70").textContent=fmt(to70);
      $("#k30").textContent=fmt(to30);
      $("#kUnpaid").textContent=fmt(unpaid);

      const by = {};
      SALES.forEach(s=>{
        const id=s.creatorId||'‚Äî';
        if(!by[id]) by[id]={id,total:0,unpaid:0};
        by[id].total += Number(s.amount||0);
        if(!s.paid) by[id].unpaid += Number(s.amount||0)*0.70;
      });

      $("#tbCreators").innerHTML = Object.values(by).sort((a,b)=>b.total-a.total).map(c=>{
        const v70=c.total*0.70, v30=c.total*0.30;
        return `<tr>
          <td>${esc(c.id)}</td>
          <td class="right">${fmt(c.total)}</td>
          <td class="right">${fmt(v70)}</td>
          <td class="right">${fmt(v30)}</td>
          <td class="right">${c.unpaid>0?`<span class="chip warn">${fmt(c.unpaid)}</span>`:`<span class="chip ok">0,00 CHF</span>`}</td>
          <td class="right">${c.unpaid>0?`<button class="btn small ghost" data-mark="${esc(c.id)}">Marquer pay√©</button>`:'‚Äî'}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="6" class="muted">Pas encore de ventes.</td></tr>`;

      $("#tbSales").innerHTML = SALES.sort((a,b)=>String(b.date||'').localeCompare(String(a.date||''))).map(s=>{
        const d = s.date ? new Date(s.date).toLocaleString() : '‚Äî';
        return `<tr>
          <td>${d}</td><td>${esc(s.creatorId||'')}</td><td>${esc(s.type||'ppv')}</td>
          <td class="right">${fmt(s.amount||0)}</td>
          <td>${esc(s.txn||'‚Äî')}</td><td>${esc(s.clientEmail||'‚Äî')}</td>
          <td>${s.paid?'<span class="chip ok">pay√©</span>':'<span class="chip warn">impay√©</span>'}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="7" class="muted">Aucune vente.</td></tr>`;
    }

    // Mark paid (par cr√©atrice)
    $("#tbCreators").addEventListener('click', async (e)=>{
      const b=e.target.closest('button[data-mark]'); if(!b) return;
      if(!confirm('Confirmer : marquer PAY√â pour cette cr√©atrice ?')) return;
      const r=await J('/api/mark-paid',{method:'POST',body:JSON.stringify({creatorId:b.dataset.mark})});
      r.ok ? (toast('Marqu√© pay√©'), loadLedger()) : toast('Erreur /api/mark-paid', false);
    });

    // Export CSV d√©tail
    $("#exportCsv").onclick=()=>{
      const head=['date','creatorId','type','amount','txn','clientEmail','paid'];
      const rows=SALES.map(s=>[s.date||'',s.creatorId||'',s.type||'ppv',String(s.amount||0),s.txn||'',s.clientEmail||'',s.paid?'yes':'no']);
      const csv=[head,...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download=`velvet-sales-${new Date().toISOString().slice(0,10)}.csv`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    };

    // Utils
    function esc(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

    // Init / events
    $("#reloadAll").onclick=()=>{ loadUsers(); loadLedger(); };
    $("#refreshLedger").onclick=loadLedger;
    $("#fStatus").onchange=$("#fRole").onchange=$("#fQuery").oninput=()=>{ clearTimeout(window.__q); window.__q=setTimeout(renderUsers,160); };

    // Boot
    loadUsers(); loadLedger();
  </script>
</body>
</html>
