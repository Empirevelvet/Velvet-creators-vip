<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Velvet â€” CrÃ©er un item</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/admin.css"/>
</head>
<body>
  <aside class="sidebar">
    <h2>VELVET ADMIN</h2>
    <nav class="nav">
      <a href="/admin-dashboard.html">ðŸ“Š AperÃ§u</a>
      <a href="/admin-users.html">ðŸ‘¤ Comptes</a>
      <a href="/admin-dashboard.html#sales">ðŸ’³ Ventes</a>
      <a href="/admin-dashboard.html#convs">ðŸ’¬ Conversations</a>
      <a href="/admin-dashboard.html#lives">ðŸŽ¥ Lives</a>
      <a class="active" href="/admin-items.html">âž• CrÃ©er un item</a>
    </nav>
    <div class="foot">Â© Velvet Creators VIP</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="chips">
        <span class="chip">Nouveau / Modifier un item</span>
      </div>
      <div class="chips">
        <button class="btn" id="btnReload">RafraÃ®chir</button>
      </div>
    </div>

    <section class="section card" style="padding:16px">
      <h2 style="margin-bottom:10px">Formulaire</h2>
      <form id="fItem" class="grid" style="grid-template-columns:1fr 1fr; gap:14px">
        <input type="hidden" id="itemId"/>

        <div>
          <label>CrÃ©atrice (handle)</label>
          <input class="input" id="creator" placeholder="@pseudo" required />
        </div>

        <div>
          <label>Type</label>
          <select class="input" id="type" required>
            <option value="photo">Photo (PPV)</option>
            <option value="video">VidÃ©o (PPV)</option>
            <option value="ticket">Ticket live</option>
            <option value="objet">Objet</option>
          </select>
        </div>

        <div>
          <label>Titre</label>
          <input class="input" id="title" placeholder="Titre visible" required />
        </div>

        <div>
          <label>Prix (CHF)</label>
          <input class="input" id="price" type="number" step="0.01" min="0" required />
        </div>

        <div>
          <label>SKU (optionnel)</label>
          <input class="input" id="sku" placeholder="CODE-123"/>
        </div>

        <div>
          <label>VisibilitÃ©</label>
          <select class="input" id="visibility">
            <option value="public">Public (feed)</option>
            <option value="subscribers">AbonnÃ©s uniquement</option>
            <option value="vip">VIP only</option>
            <option value="hidden">CachÃ© (lien direct/chat)</option>
          </select>
        </div>

        <div style="grid-column:1/-1">
          <label>Description (optionnel)</label>
          <textarea class="input" id="desc" rows="4" placeholder="DÃ©tails, conditions, etc."></textarea>
        </div>

        <div style="grid-column:1/-1; display:flex; gap:8px; align-items:center">
          <button class="btn" type="submit">Enregistrer</button>
          <button type="button" class="btn ghost" id="btnReset">RÃ©initialiser</button>
        </div>
      </form>
    </section>

    <section class="section">
      <h2>Items existants</h2>
      <table id="t-items">
        <thead><tr><th>CrÃ©atrice</th><th>Type</th><th>Titre</th><th>Prix</th><th>VisibilitÃ©</th><th>SKU</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="7">Chargementâ€¦</td></tr></tbody>
      </table>
    </section>
  </main>

<script>
const $=s=>document.querySelector(s);
const api=(p,opt={})=>fetch(p,{headers:{'Content-Type':'application/json'},...opt});
const CHF=n=>Number(n||0).toFixed(2);

async function loadItems(){
  const tb = $('#t-items tbody'); tb.innerHTML='<tr><td colspan="7">Chargementâ€¦</td></tr>';
  const r = await api('/api/list-items');
  if(!r.ok){ tb.innerHTML='<tr><td colspan="7">Erreur chargement</td></tr>'; return; }
  const j = await r.json();
  const rows = j.items||[];
  if(!rows.length){ tb.innerHTML='<tr><td colspan="7">Aucun item</td></tr>'; return; }
  tb.innerHTML = rows.map(it=>`
    <tr>
      <td>${it.creator||'-'}</td>
      <td>${it.type||'-'}</td>
      <td>${it.title||'-'}</td>
      <td>${CHF(it.price)} CHF</td>
      <td>${it.visibility||'-'}</td>
      <td>${it.sku||'-'}</td>
      <td>
        <button class="btn" data-edit="${it.id}">Ã‰diter</button>
        <button class="btn danger" data-del="${it.id}">Supprimer</button>
      </td>
    </tr>
  `).join('');
}

$('#t-items').addEventListener('click', async (e)=>{
  const bEdit=e.target.closest('button[data-edit]'); const bDel=e.target.closest('button[data-del]');
  if(bEdit){
    const id=bEdit.dataset.edit;
    const r = await api('/api/list-items'); const j=await r.json();
    const it = (j.items||[]).find(x=>String(x.id)===String(id));
    if(!it) return;
    $('#itemId').value=it.id||'';
    $('#creator').value=it.creator||'';
    $('#type').value=it.type||'photo';
    $('#title').value=it.title||'';
    $('#price').value=it.price||0;
    $('#sku').value=it.sku||'';
    $('#visibility').value=it.visibility||'public';
    $('#desc').value=it.desc||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
  if(bDel){
    if(!confirm('Supprimer cet item ?')) return;
    const id=bDel.dataset.del;
    const r = await api('/api/delete-item',{method:'POST', body:JSON.stringify({id})});
    if(!r.ok) { alert('Erreur suppression'); return; }
    loadItems();
  }
});

$('#fItem').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    id: $('#itemId').value || undefined,
    creator: $('#creator').value.trim(),
    type: $('#type').value,
    title: $('#title').value.trim(),
    price: Number($('#price').value || 0),
    sku: ($('#sku').value||'').trim(),
    visibility: $('#visibility').value,
    desc: ($('#desc').value||'').trim()
  };
  if(!payload.creator || !payload.title){ alert('Champs requis manquants'); return; }
  const r = await api('/api/upsert-item',{method:'POST', body:JSON.stringify(payload)});
  if(!r.ok){ alert('Erreur enregistrement'); return; }
  $('#fItem').reset(); $('#itemId').value='';
  loadItems();
});
$('#btnReset').onclick = ()=>{ $('#fItem').reset(); $('#itemId').value=''; };
$('#btnReload').onclick = loadItems;

loadItems();
</script>
</body>
</html>
