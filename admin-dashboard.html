<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Velvet ‚Äî Admin Dashboard</title>

<style>
:root{
  --bg:#0b0b0c; --panel:#121214; --panel-2:#17171a;
  --line:#2a2a2f; --ink:#e6e6e9; --muted:#9aa0a6;
  --gold:#d4af37; --gold-2:#c39a2e;
  --ok:#43a047; --danger:#ef5350; --chip:#232329;
  --rad:14px; --shadow:0 10px 28px rgba(0,0,0,.45);
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  --sans: ui-sans-serif, system-ui, Segoe UI, Inter, Roboto, Arial, sans-serif;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#0a0a0b 0%, #0f0f12 100%);
  color:var(--ink); font:15px/1.55 var(--sans);
}
a{color:var(--gold); text-decoration:none}
a:hover{opacity:.85}

/* Layout */
.layout{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
.aside{
  background:linear-gradient(180deg,#0e0e10,#0a0a0b);
  border-right:1px solid var(--line);
  padding:18px 14px; position:sticky; top:0; height:100vh;
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px}
.brand .dot{width:12px; height:12px; border-radius:50%; background:var(--gold); box-shadow:0 0 0 4px #2a2413}
.brand small{display:block; color:var(--muted); margin-top:2px; font-weight:600; opacity:.85}
.menu{margin:16px 0}
.menu a{
  display:flex; align-items:center; gap:10px; padding:11px 12px; border-radius:10px;
  color:var(--ink); border:1px solid transparent;
}
.menu a:hover{background:var(--chip); border-color:#1e1e24}
.menu a.active{background:#151519; border-color:#24242a; box-shadow:inset 0 0 0 1px #1e1e24}
.menu .emoji{width:24px; text-align:center}

.content{padding:18px; }
.topbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  position:sticky; top:0; background:linear-gradient(180deg,rgba(11,11,12,.92),rgba(11,11,12,.75));
  backdrop-filter:saturate(110%) blur(8px); border-bottom:1px solid var(--line); padding:12px 14px; z-index:2; border-radius:12px;
}
.searchbar{display:flex; gap:8px; align-items:center}
.input, .select{
  background:#111115; color:var(--ink);
  border:1px solid var(--line); border-radius:12px; padding:10px 12px;
}
.btn{
  background:var(--gold); color:#111; font-weight:800; border:0; border-radius:999px;
  padding:10px 14px; cursor:pointer;
  box-shadow:0 6px 18px rgba(212,175,55,.25), inset 0 1px 0 rgba(255,255,255,.25);
}
.btn:hover{filter:brightness(.98)}
.btn.ghost{background:#1a1a1f; color:var(--ink); border:1px solid var(--line); box-shadow:none}
.btn.warn{background:#27231a; color:#f7e7b0; border:1px solid #4a3d16}
.btn.danger{background:#2b1717; color:#ffbdbd; border:1px solid #5a2424}

/* Cards & grids */
.grid{display:grid; gap:14px}
.kpis{grid-template-columns: repeat(4, minmax(220px,1fr))}
.card{
  background: radial-gradient(120% 120% at 0% 0%, #121216 0%, #0f1013 100%);
  border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
  padding:14px; position:relative;
}
.card h3{margin:0 0 6px 0; font-size:15px; color:#ccd0d6}
.big{font:800 26px/1 var(--sans)}
.big .unit{font:700 13px/1 var(--sans); color:#bfc4cc; margin-left:6px}
.sub{color:var(--muted); font-size:12.5px; margin-top:6px}

.split{display:grid; grid-template-columns:1fr 420px; gap:14px}
.section h2{margin:0 0 10px 0}
.section .card{padding:0}
.section .head{
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--line); padding:12px 14px;
}
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th,.table td{padding:10px 12px; border-bottom:1px dashed #202026}
.table th{color:#b6bbc5; text-align:left; font-weight:700; font-size:12.5px; letter-spacing:.3px}
.table tr:last-child td{border-bottom:0}
.empty{padding:14px; color:var(--muted)}

/* Chips & misc */
.chips{display:flex; gap:8px; align-items:center}
.chip{background:var(--chip); border:1px solid #1e1e24; color:#cbd1db; padding:7px 10px; border-radius:999px; font-weight:700; font-size:12.5px}
.ok{color:#9cf3a9}
.bad{color:#ff9e9e}
.right{display:flex; gap:8px; align-items:center}
.mono{font-family:var(--mono)}
footer{color:#8b8f98; font-size:12px; padding:10px 2px}
@media (max-width:1080px){
  .layout{grid-template-columns:1fr}
  .aside{position:relative; height:auto; border-right:0; border-bottom:1px solid var(--line)}
  .split{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="aside">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div>VELVET <b>ADMIN</b></div>
        <small>Creators VIP</small>
      </div>
    </div>
    <nav class="menu">
      <a href="#apercu" class="active"><span class="emoji">üìä</span> Aper√ßu</a>
      <a href="#comptes"><span class="emoji">üë§</span> Comptes</a>
      <a href="#ventes"><span class="emoji">üí≥</span> Ventes</a>
      <a href="#conversations"><span class="emoji">üí¨</span> Conversations</a>
      <a href="#lives"><span class="emoji">üî¥</span> Lives</a>
      <a href="admin-items.html"><span class="emoji">üéüÔ∏è</span> Cr√©er un item</a>
    </nav>
    <footer>¬© Velvet Creators VIP</footer>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="apercu">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="searchbar">
        <input id="q" class="input" placeholder="Rechercher (pseudo, email‚Ä¶)" />
        <button class="btn" id="btnFilter">Filtrer</button>
        <span class="chip mono" id="clock">--:--:--</span>
      </div>
      <div class="right">
        <button class="btn warn" id="btnPurge">Purger inactifs (90 j)</button>
        <button class="btn ghost" id="btnReload">Rafra√Æchir</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid kpis" style="margin:14px 0">
      <div class="card">
        <h3>Utilisateurs en ligne</h3>
        <div class="big" id="k_online">0 <span class="unit">dans les 5 derni√®res minutes</span></div>
      </div>
      <div class="card">
        <h3>Inscriptions en attente</h3>
        <div class="big" id="k_pending">0 <span class="unit">√† valider</span></div>
      </div>
      <div class="card">
        <h3>Ventes (aujourd‚Äôhui)</h3>
        <div class="big"><span id="k_sales">0.00</span> <span class="unit">CHF</span></div>
        <div class="sub">tickets & PPV</div>
      </div>
      <div class="card">
        <h3>Impay√© total</h3>
        <div class="big bad"><span id="k_unpaid">0.00</span> <span class="unit">CHF</span></div>
        <div class="sub">√† verser aux cr√©atrices</div>
      </div>
    </div>

    <!-- DERNI√àRES VENTES + R√âCAP CR√âATRICES -->
    <div class="split">
      <section class="section card">
        <div class="head"><h2>Derni√®res ventes</h2></div>
        <div style="padding:4px 10px 12px">
          <table class="table" id="tblLast">
            <thead><tr>
              <th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Client</th><th>Action</th>
            </tr></thead>
            <tbody><tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </section>

      <section class="section card">
        <div class="head">
          <h2>R√©cap ventes par cr√©atrice</h2>
          <button class="btn" id="btnCsv">Exporter CSV</button>
        </div>
        <div style="padding:4px 10px 12px">
          <table class="table" id="tblCreators">
            <thead><tr>
              <th>Cr√©atrice</th><th>Ventes (CHF)</th><th>Pour elle (70%)</th><th>Pour Velvet (30%)</th><th>Impay√©</th><th>Action</th>
            </tr></thead>
            <tbody><tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- COMPTES -->
    <a id="comptes"></a>
    <section class="section card" style="margin-top:14px">
      <div class="head">
        <h2>Comptes ‚Äî valider / suspendre / supprimer</h2>
      </div>
      <div style="padding:12px 14px; border-bottom:1px solid var(--line); color:#c7cbd3">
        ‚ÄúSuspendre‚Äù bloque l‚Äôacc√®s sans supprimer les donn√©es. Les motifs sont enregistr√©s.
      </div>
      <div style="padding:10px 14px">
        <div class="chips" style="margin-bottom:10px">
          <select id="f_status" class="select">
            <option value="">Statut : Tous</option>
            <option value="pending">En attente</option>
            <option value="active">Actif</option>
            <option value="suspended">Suspendu</option>
          </select>
          <select id="f_role" class="select">
            <option value="">R√¥le : Tous</option>
            <option value="creatrice">Cr√©atrice</option>
            <option value="client">Client</option>
          </select>
          <input id="f_q" class="input" placeholder="pseudo / email‚Ä¶" />
          <button class="btn" id="btnUsersFilter">Filtrer</button>
        </div>

        <table class="table" id="tblUsers">
          <thead><tr>
            <th>Date</th><th>Pseudo</th><th>Email</th><th>R√¥le</th><th>Statut</th><th>Action</th>
          </tr></thead>
          <tbody><tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr></tbody>
        </table>
        <div id="usersErr" class="empty" style="display:none;color:#ffbdbd">Erreur chargement utilisateurs</div>
      </div>
    </section>

    <!-- D√âTAIL DES VENTES -->
    <a id="ventes"></a>
    <section class="section card" style="margin-top:14px">
      <div class="head"><h2>D√©tail des ventes</h2></div>
      <div style="padding:10px 14px">
        <table class="table" id="tblSales">
          <thead><tr>
            <th>Date</th><th>Cr√©atrice</th><th>Type</th><th>Montant</th><th>Txn</th><th>Email client</th><th>Statut</th><th>Action</th>
          </tr></thead>
          <tbody><tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr></tbody>
        </table>
        <div id="salesErr" class="empty" style="display:none;color:#ffbdbd">Erreur chargement ventes</div>
      </div>
    </section>

    <!-- CONVERSATIONS -->
    <a id="conversations"></a>
    <section class="section card" style="margin-top:14px">
      <div class="head"><h2>Conversations (aper√ßu)</h2></div>
      <div id="convBox" class="empty">Indisponible.</div>
    </section>

    <!-- LIVES -->
    <a id="lives"></a>
    <section class="section card" style="margin:14px 0">
      <div class="head"><h2>Lives en cours / √† venir</h2></div>
      <div id="liveBox" class="empty">Indisponible.</div>
    </section>

  </main>
</div>

<script>
/* ========= UTIL ========= */
const CHF = n => Number(n||0).toFixed(2);
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const setClock = () => { $("#clock").textContent = new Date().toLocaleTimeString(); };

/* ========= CHARGEMENT DONN√âES ========= */
async function api(path, opt={}){
  const r = await fetch(path, {headers:{'Content-Type':'application/json'}, ...opt});
  let data=null; try{ data = await r.json(); }catch{ /* html/empty */ }
  return { ok:r.ok, data, status:r.status };
}

async function loadUsers(){
  const tbody = $("#tblUsers tbody"); $("#usersErr").style.display="none";
  tbody.innerHTML = `<tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>`;
  const q = $("#f_q").value.trim(), role=$("#f_role").value, status=$("#f_status").value;
  const {ok,data} = await api('/api/list-users');
  if(!ok || !data?.users){ $("#usersErr").style.display="block"; return; }
  let list = data.users;
  if(q) list = list.filter(u => (u.username||'').toLowerCase().includes(q.toLowerCase()) || (u.email||'').toLowerCase().includes(q.toLowerCase()));
  if(role) list = list.filter(u => (u.role||'')===role);
  if(status) list = list.filter(u => (u.status||'')===status);
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="6" class="empty">Aucun r√©sultat</td></tr>`; return; }

  tbody.innerHTML = list.map(u=>{
    const created = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-';
    const sChip = u.status==='active' ? '<span class="chip ok">actif</span>' :
                 u.status==='pending' ? '<span class="chip">en attente</span>' :
                 '<span class="chip bad">suspendu</span>';
    return `<tr>
      <td>${created}</td>
      <td>${u.username||'-'}</td>
      <td>${u.email||'-'}</td>
      <td>${u.role||'-'}</td>
      <td>${sChip}</td>
      <td class="right">
        <button class="btn ghost" data-act="validate" data-id="${u.id}">Valider</button>
        <button class="btn warn" data-act="suspend" data-id="${u.id}">Suspendre</button>
        <button class="btn danger" data-act="delete" data-id="${u.id}">Supprimer</button>
      </td>
    </tr>`
  }).join('');
}

async function loadLedger(){
  // KPI + Last + Creators recap + Detail
  const lastT = $("#tblLast tbody");
  const crT = $("#tblCreators tbody");
  const detT = $("#tblSales tbody");
  lastT.innerHTML = `<tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>`;
  crT.innerHTML   = `<tr><td colspan="6" class="empty">Chargement‚Ä¶</td></tr>`;
  detT.innerHTML  = `<tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr>`;

  const {ok, data} = await api('/api/list-ledger');
  if(!ok || !data){ $("#salesErr").style.display="block"; return; }

  // KPIs
  $("#k_online").textContent  = (data.kpis?.online||0) + ' ';
  $("#k_pending").textContent = (data.kpis?.pending||0) + ' ';
  $("#k_sales").textContent   = CHF(data.kpis?.salesToday||0);
  $("#k_unpaid").textContent  = CHF(data.kpis?.unpaidTotal||0);

  // Derni√®res ventes
  const last = data.lastSales||[];
  lastT.innerHTML = last.length? last.map(s=>{
    const d = s.date ? new Date(s.date).toLocaleString() : '-';
    return `<tr>
      <td>${d}</td>
      <td>${s.creator||'-'}</td>
      <td>${s.type||'-'}</td>
      <td>${CHF(s.amount)} CHF</td>
      <td>${s.clientEmail||'-'}</td>
      <td class="right">
        ${s.status==='paid'
          ? '<span class="chip ok">pay√©</span>'
          : `<button class="btn" data-pay="${s.id}">Marquer pay√©</button>`}
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="6" class="empty">Aucune vente r√©cente</td></tr>`;

  // R√©cap cr√©atrices
  const rec = data.creators||[];
  crT.innerHTML = rec.length? rec.map(c=>{
    return `<tr>
      <td>${c.name||c.id||'-'}</td>
      <td>${CHF(c.total||0)}</td>
      <td>${CHF((c.total||0)*0.70)}</td>
      <td>${CHF((c.total||0)*0.30)}</td>
      <td class="bad">${CHF(c.unpaid||0)}</td>
      <td class="right">${(c.unpaid||0)>0? `<button class="btn" data-pay-creator="${c.id}">Marquer pay√©</button>`:''}</td>
    </tr>`;
  }).join('') : `<tr><td colspan="6" class="empty">Pas de ventes</td></tr>`;

  // D√©tail des ventes
  const rows = data.sales||[];
  detT.innerHTML = rows.length? rows.map(s=>{
    const d = s.date ? new Date(s.date).toLocaleString() : '-';
    return `<tr>
      <td>${d}</td><td>${s.creator||'-'}</td><td>${s.type||'-'}</td>
      <td>${CHF(s.amount)} CHF</td><td class="mono">${s.txn||'-'}</td>
      <td>${s.clientEmail||'-'}</td>
      <td>${s.status==='paid' ? '<span class="chip ok">pay√©</span>' : '<span class="chip">impay√©</span>'}</td>
      <td class="right">
        ${s.status!=='paid' ? `<button class="btn" data-pay="${s.id}">Marquer pay√©</button>` : ''}
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="8" class="empty">Aucune donn√©e</td></tr>`;
}

async function exportCsv(){
  const r = await api('/api/list-ledger');
  if(!r.ok || !r.data?.sales?.length){ alert('Aucune vente'); return; }
  const head = ['date','creator','type','amount','txn','clientEmail','status'];
  const lines = [head.join(',')].concat(
    r.data.sales.map(s=> head.map(k=>{
      const v = s[k] ?? '';
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(','))
  ).join('\n');
  const blob = new Blob([lines], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ventes.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ========= ACTIONS ========= */
document.addEventListener('click', async (ev)=>{
  const payId = ev.target?.dataset?.pay;
  const payCreator = ev.target?.dataset?.payCreator;
  const act = ev.target?.dataset?.act;
  if(payId){
    if(!confirm('Confirmer : marquer pay√© cette vente ?')) return;
    const r = await api('/api/mark-paid',{method:'POST', body:JSON.stringify({ saleId: payId })});
    r.ok ? loadLedger() : alert('Erreur mark-paid');
  }
  if(payCreator){
    if(!confirm('Confirmer : marquer pay√© l‚Äôimpay√© de cette cr√©atrice ?')) return;
    const r = await api('/api/mark-paid',{method:'POST', body:JSON.stringify({ creatorId: payCreator })});
    r.ok ? loadLedger() : alert('Erreur mark-paid');
  }
  if(act){
    const id = ev.target.dataset.id;
    if(!id) return;
    let endpoint = '/api/moderate';
    const reason = act==='suspend' ? (prompt('Motif de suspension :','Mod√©ration')||'') : '';
    const payload = { action:act, userId:id, reason };
    if(act==='delete' && !confirm('Supprimer le compte ? Action irr√©versible.')) return;
    const r = await api(endpoint,{method:'POST', body:JSON.stringify(payload)});
    r.ok ? loadUsers() : alert('Erreur mod√©ration');
  }
});

/* ========= CHARGEMENT CONV/LIVES (optionnels) ========= */
async function loadConversations(){
  const box = $("#convBox"); box.textContent = 'Chargement‚Ä¶';
  const r = await api('/api/list-conversations');
  if(!r.ok || !r.data?.items){ box.textContent = 'Indisponible.'; return; }
  box.innerHTML = r.data.items.slice(0,8).map(c=>`
    <div style="display:flex; justify-content:space-between; padding:8px 12px; border-bottom:1px dashed #202026">
      <div><b>${c.with||'-'}</b> ‚Ä¢ ${c.lastMsg||'-'}</div>
      <div class="mono" style="color:#9aa0a6">${new Date(c.updatedAt).toLocaleString()}</div>
    </div>
  `).join('') || 'Indisponible.';
}

async function loadLives(){
  const box = $("#liveBox"); box.textContent = 'Chargement‚Ä¶';
  const r = await api('/api/list-lives');
  if(!r.ok || !r.data?.items){ box.textContent = 'Indisponible.'; return; }
  box.innerHTML = r.data.items.slice(0,8).map(l=>`
    <div style="display:flex; justify-content:space-between; padding:8px 12px; border-bottom:1px dashed #202026">
      <div><b>${l.room||'-'}</b> ‚Äî ${l.title||'Live priv√©'} <span class="chip">${l.status||'√† venir'}</span></div>
      <div class="mono" style="color:#9aa0a6">${new Date(l.startAt).toLocaleString()}</div>
    </div>
  `).join('') || 'Indisponible.';
}

/* ========= PURGE INACTIFS 90j ========= */
async function purgeInactive(){
  if(!confirm('Supprimer les comptes inactifs depuis 90 jours ?')) return;
  const r = await api('/api/purge-inactive?days=90',{method:'POST'});
  r.ok ? (alert('Purge effectu√©e'), loadUsers()) : alert('Erreur purge');
}

/* ========= INIT + AUTO REFRESH ========= */
function init(){
  setClock(); setInterval(setClock, 1000);
  $("#btnReload").onclick = ()=>{ loadUsers(); loadLedger(); loadConversations(); loadLives(); };
  $("#btnUsersFilter").onclick = loadUsers;
  $("#btnFilter").onclick = ()=>{ $("#f_q").value = $("#q").value; loadUsers(); };
  $("#btnCsv").onclick = exportCsv;
  $("#btnPurge").onclick = purgeInactive;

  loadUsers(); loadLedger(); loadConversations(); loadLives();
  setInterval(()=>{ loadUsers(); loadLedger(); loadConversations(); loadLives(); }, 30000); // 30s
}
init();
</script>
</body>
</html>
